<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0D0D0D">
    <title>10:13</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Karla:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Karla', sans-serif;
            background-color: #0D0D0D;
            color: #FFFFFF;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .logo {
            font-size: 48px;
            font-weight: 700;
            text-transform: lowercase;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00FFFF, #FF00FF, #FFFF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version {
            font-size: 14px;
            color: #666;
            margin-bottom: 40px;
            text-transform: lowercase;
        }

        .btn {
            background-color: #FFFFFF;
            color: #0D0D0D;
            border: none;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            max-width: 300px;
        }

        /* Chart Screen */
        .chart-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .chart-screen.active {
            display: block;
        }

        .chart-wrapper {
            width: 100%;
            height: 100%;
            padding: 20px;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
            text-transform: lowercase;
            cursor: pointer;
            background: linear-gradient(45deg, #00FFFF, #FF00FF, #FFFF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .toggle {
            display: flex;
            align-items: center;
            background-color: #1A1A1A;
            border-radius: 20px;
            padding: 4px;
        }

        .toggle-btn {
            background-color: transparent;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background-color: #FFFFFF;
            color: #0D0D0D;
        }

        .chart-container {
            flex: 1;
            position: relative;
            padding: 0 20px 60px 20px;
            min-height: 0;
            height: calc(100% - 80px);
        }

        .view-toggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: #1A1A1A;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .view-btn {
            background-color: transparent;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s;
        }

        .view-btn.active {
            background-color: #FFFFFF;
            color: #0D0D0D;
        }

        /* Quiz Screen */
        .quiz-screen {
            display: none;
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .quiz-screen.active {
            display: block;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 6px;
            background: linear-gradient(90deg, #00FFFF, #FF00FF, #FFFF00);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }

        .card-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .card {
            width: 100%;
            max-width: 400px;
            height: 60%;
            border-radius: 16px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: grab;
            user-select: none;
            transition: all 0.3s ease;
            border: 2px solid;
            background-color: #0D0D0D;
        }

        .card.dragging {
            cursor: grabbing;
            transition: none;
        }

        .section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            text-transform: lowercase;
            font-weight: 700;
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        .question-text {
            font-size: 48px;
            font-weight: 700;
            text-transform: lowercase;
            line-height: 1.2;
            text-align: center;
            word-break: break-word;
        }

        .rating-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            flex: 1;
            justify-content: center;
        }

        .rating-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.2s;
            background-color: transparent;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            flex: 1;
            justify-content: center;
        }

        .slider-value {
            font-size: 72px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .slider-wrapper {
            width: 100%;
            max-width: 350px;
        }

        .hour-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            background: #1A1A1A;
        }

        .hour-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
        }

        .hour-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .slider-submit {
            background-color: transparent;
            border: 2px solid;
            padding: 12px 32px;
            border-radius: 8px;
            font-family: 'Karla', sans-serif;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            text-transform: lowercase;
            transition: all 0.2s;
        }

        .slider-submit:active {
            transform: scale(0.95);
        }

        .text-input-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
            justify-content: center;
        }

        .text-input {
            width: 100%;
            min-height: 150px;
            background-color: transparent;
            border: 2px solid #FFFFFF;
            border-radius: 8px;
            padding: 16px;
            color: #FFFFFF;
            font-family: 'Karla', sans-serif;
            font-size: 16px;
            font-weight: 700;
            resize: none;
            outline: none;
        }

        .text-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .mic-btn, .submit-btn {
            background-color: transparent;
            border: 2px solid #FFFFFF;
            color: #FFFFFF;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: 'Karla', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .mic-btn:active, .submit-btn:active {
            background-color: #FFFFFF;
            color: #0D0D0D;
        }

        .mic-btn.recording {
            background-color: #FF0000;
            border-color: #FF0000;
            color: #FFFFFF;
        }

        /* Data Popup */
        .data-popup {
            position: fixed;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            background-color: #0D0D0D;
            border: 2px solid #FFFFFF;
            border-radius: 16px;
            padding: 32px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .data-popup.active {
            display: block;
        }

        .popup-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 20px;
            text-transform: lowercase;
        }

        .popup-section {
            margin-bottom: 24px;
        }

        .popup-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: lowercase;
        }

        .popup-item {
            margin-left: 28px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .popup-item.yes {
            opacity: 1;
        }

        .popup-item.no {
            opacity: 0.3;
        }

        .popup-response {
            background-color: #1A1A1A;
            border: 2px solid #FFFFFF;
            border-radius: 8px;
            padding: 16px;
            color: #FFFFFF;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 8px;
            white-space: pre-wrap;
        }

        .popup-rating {
            font-size: 48px;
            font-weight: 700;
            color: #FFFFFF;
            text-align: center;
            margin: 16px 0;
        }

        .popup-hours {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin: 12px 0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="logo">10:13</div>
        <!-- UPDATE VERSION NUMBER HERE when artifact changes -->
        <div class="version">v20</div>
        <button class="btn" onclick="handleGoogleLogin()">sign in with google</button>
    </div>

    <!-- Chart Screen -->
    <div id="chartScreen" class="chart-screen">
        <div class="chart-wrapper">
            <div class="header">
                <div class="title" onclick="startQuiz()">10:13</div>
                <div class="toggle">
                    <button class="toggle-btn active" id="toggle30d" onclick="setChartView(false)">30d</button>
                    <button class="toggle-btn" id="toggleAll" onclick="setChartView(true)">all</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="myChart"></canvas>
                <div class="view-toggle">
                    <button class="view-btn active" id="viewPercent" onclick="setChartMode('percent')">%</button>
                    <button class="view-btn" id="viewHours" onclick="setChartMode('hours')">hours</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Popup -->
    <div id="dataPopup" class="data-popup">
        <div id="popupContent"></div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="quiz-screen">
        <div class="progress-bar" id="progressBar"></div>
        <div class="card-container">
            <div class="card" id="card">
                <div class="section-label" id="sectionLabel"></div>
                <div id="cardContent"></div>
                <div></div>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // ============================================
        // QUESTIONS CONFIGURATION - EDIT THIS SECTION
        // ============================================
        const QUESTIONS = [
            // morning section
            { section: 'morning', text: 'make bed?', color: 'M' },
            { section: 'morning', text: 'brush teeth?', color: 'C' },
            { section: 'morning', text: 'colostrum?', color: 'C' },
            { section: 'morning', text: 'morning run?', color: 'C' },
            { section: 'morning', text: 'fruit / granola / yogurt?', color: 'C' },
            { section: 'morning', text: 'journal?', color: 'M' },
            { section: 'morning', text: 'shower?', color: 'C' },
            { section: 'morning', text: 'rogaine?', color: 'C' },
            { section: 'morning', text: 'shave?', color: 'M' },
            { section: 'morning', text: 'face lotion?', color: 'C' },
            { section: 'morning', text: 'clean ear?', color: 'C' },
            
            // evening section
            { section: 'evening', text: 'colostrum?', color: 'C' },
            { section: 'evening', text: 'body weight workout?', color: 'C' },
            { section: 'evening', text: 'shower / bath?', color: 'C' },
            { section: 'evening', text: 'rogaine?', color: 'C' },
            { section: 'evening', text: 'face lotion?', color: 'C' },
            { section: 'evening', text: 'clean ear?', color: 'C' },
            { section: 'evening', text: 'brush teeth?', color: 'C' },
            { section: 'evening', text: 'read?', color: 'M' },
            
            // daily substances
            { section: 'daily', text: 'nicotine free ?', color: 'M' },
            { section: 'daily', text: 'cannabis free ?', color: 'M' },
            { section: 'daily', text: 'alcohol free?', color: 'M' },
            { section: 'daily', text: 'caffeine?', color: 'M' },
            { section: 'daily', text: 'Nootropics?', color: 'M' },           
            
            // daily social
            { section: 'daily', text: 'connect with friends?', color: 'Y' },
            { section: 'daily', text: 'connect with family?', color: 'Y' },
            { section: 'daily', text: 'quality time with Maria?', color: 'Y' },
            
            // hours tracking
            { section: 'hours', text: 'pinkProportion Hours', color: 'M' },
            { section: 'hours', text: 'Forma Rosa Studio Hours', color: 'C' },
            { section: 'hours', text: 'Forma Rosa Creative Hours', color: 'Y' },
            { section: 'hours', text: 'health', color: 'W' },
            
            // daily reflections
            { section: 'text', text: 'daily response', color: 'W' },
            { section: 'rating', text: 'daily rating', color: 'W' }
        ];

        // ============================================
        // APP CONFIGURATION
        // ============================================
        const CLIENT_ID = '785091900263-bqe75ticj4pr0uovtb1b0c5d8ogpnvm8.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1HelegJqWzHBK-mTqc6mYlGI3OrgBP8Ge8Vw6BbL7Z5Q';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        const COLOR_MAP = {
            'C': '#00FFFF',  // Cyan
            'M': '#FF00FF',  // Magenta
            'Y': '#FFFF00',  // Yellow
            'W': '#FFFFFF'   // White
        };

        const SECTION_LABELS = {
            'morning': 'Morning Checklist',
            'evening': 'Evening Checklist',
            'daily': 'Daily Checklist',
            'hours': 'Hours Tracking',
            'text': 'Daily Response',
            'rating': 'Daily Rating'
        };

        // SVG Icons
        const SUN_ICON = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
        
        const MOON_ICON = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
        
        const MIC_ICON = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';

        // ============================================
        // APP STATE
        // ============================================
        let accessToken = null;
        let tokenClient = null;
        let currentQuestionIndex = 0;
        let responses = {};
        let dragStartX = 0;
        let dragOffset = 0;
        let isDragging = false;
        let showAllData = false;
        let chartMode = 'percent'; // 'percent' or 'hours'
        let quizData = [];
        let chart = null;
        let recognition = null;
        let isRecording = false;

        // Process questions
        const questions = QUESTIONS.map(q => {
            let type = 'yesno';
            if (q.section === 'rating') type = 'rating';
            if (q.section === 'text') type = 'text';
            if (q.section === 'hours') type = 'hours';
            
            return {
                ...q,
                type: type,
                colorHex: COLOR_MAP[q.color]
            };
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        loadSheetData();
                        showScreen('chartScreen');
                    }
                },
            });

            // Initialize speech recognition
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    const textInput = document.getElementById('textInput');
                    if (textInput) {
                        textInput.value = transcript;
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                };

                recognition.onend = () => {
                    if (isRecording) {
                        stopRecording();
                    }
                };
            }

            initPopupDragHandlers();
        };

        function handleGoogleLogin() {
            tokenClient.requestAccessToken();
        }

        // ============================================
        // GOOGLE SHEETS API
        // ============================================
        async function loadSheetData() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A:ZZ`,
                    {
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        }
                    }
                );

                const data = await response.json();

                if (data.values && data.values.length > 1) {
                    const headers = data.values[0];
                    quizData = data.values.slice(1).map(row => {
                        const entry = {};
                        headers.forEach((header, index) => {
                            entry[header] = row[index] || '';
                        });
                        return entry;
                    });
                } else {
                    quizData = [];
                }

                updateChart();
            } catch (error) {
                console.error('Error loading sheet data:', error);
                quizData = [];
                updateChart();
            }
        }

        async function saveToSheet(data) {
            const headers = ['timestamp', ...questions.map(q => q.text)];
            const row = [data.timestamp, ...questions.map(q => data[q.text] !== undefined ? data[q.text] : '')];

            try {
                // Check if headers exist
                const checkResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A1:ZZ1`,
                    {
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        }
                    }
                );

                const checkData = await checkResponse.json();

                // Add headers if they don't exist
                if (!checkData.values || checkData.values.length === 0) {
                    await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A1:append?valueInputOption=RAW`,
                        {
                            method: 'POST',
                            headers: {
                                Authorization: `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                values: [headers]
                            })
                        }
                    );
                }

                // Append data row
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A:ZZ:append?valueInputOption=RAW`,
                    {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            values: [row]
                        })
                    }
                );

                await loadSheetData();
            } catch (error) {
                console.error('Error saving to sheet:', error);
            }
        }

        // ============================================
        // UI NAVIGATION
        // ============================================
        function showScreen(screenId) {
            // Clean up when leaving quiz
            if (screenId !== 'quizScreen') {
                stopRecording();
                responses = {};
            }

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('chartScreen').classList.remove('active');
            document.getElementById('quizScreen').classList.remove('active');

            if (screenId === 'chartScreen') {
                document.getElementById('chartScreen').classList.add('active');
            } else if (screenId === 'quizScreen') {
                document.getElementById('quizScreen').classList.add('active');
            } else {
                document.getElementById(screenId).classList.remove('hidden');
            }
        }

        function setChartView(showAll) {
            showAllData = showAll;
            document.getElementById('toggle30d').classList.toggle('active', !showAll);
            document.getElementById('toggleAll').classList.toggle('active', showAll);
            updateChart();
        }

        function setChartMode(mode) {
            chartMode = mode;
            document.getElementById('viewPercent').classList.toggle('active', mode === 'percent');
            document.getElementById('viewHours').classList.toggle('active', mode === 'hours');
            updateChart();
        }

        // ============================================
        // DATA POPUP
        // ============================================
        function initPopupDragHandlers() {
            const popup = document.getElementById('dataPopup');
            let popupDragStartX = 0;
            let popupDragOffset = 0;
            let popupIsDragging = false;

            const startPopupDrag = (e) => {
                if (e.target.id === 'dataPopup') {
                    popupIsDragging = true;
                    popupDragStartX = e.touches ? e.touches[0].clientX : e.clientX;
                    popupDragOffset = 0;
                }
            };

            const popupDrag = (e) => {
                if (!popupIsDragging) return;
                const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                popupDragOffset = currentX - popupDragStartX;
            };

            const endPopupDrag = () => {
                if (!popupIsDragging) return;

                if (Math.abs(popupDragOffset) > 100) {
                    closeDataPopup();
                }

                popupIsDragging = false;
                popupDragOffset = 0;
            };

            popup.addEventListener('touchstart', startPopupDrag, { passive: false });
            popup.addEventListener('touchmove', popupDrag, { passive: false });
            popup.addEventListener('touchend', endPopupDrag);
            popup.addEventListener('mousedown', startPopupDrag);
            document.addEventListener('mousemove', popupDrag);
            document.addEventListener('mouseup', endPopupDrag);
        }

        function showDataPopup(timestamp) {
            const entry = quizData.find(e => e.timestamp === timestamp);
            if (!entry) return;

            const ts = new Date(entry.timestamp);
            const displayTime = ts.toLocaleString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            let content = `<div class="popup-date">${displayTime}</div>`;

            // Daily rating FIRST
            const ratingQuestion = questions.find(q => q.section === 'rating');
            if (ratingQuestion && entry[ratingQuestion.text]) {
                const rating = entry[ratingQuestion.text];
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title"><span>Daily Rating</span></div>`;
                content += `<div class="popup-rating">${rating > 0 ? '+' : ''}${rating}</div>`;
                content += `</div>`;
            }

            // Daily response SECOND
            const responseQuestion = questions.find(q => q.section === 'text');
            if (responseQuestion && entry[responseQuestion.text]) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title"><span>Daily Response</span></div>`;
                content += `<div class="popup-response">${entry[responseQuestion.text]}</div>`;
                content += `</div>`;
            }

            // Hours tracking
            const hoursQuestions = questions.filter(q => q.section === 'hours');
            if (hoursQuestions.length > 0 && hoursQuestions.some(q => entry[q.text])) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title"><span>Hours Tracking</span></div>`;
                hoursQuestions.forEach(q => {
                    const hours = entry[q.text];
                    if (hours !== undefined && hours !== '') {
                        content += `<div class="popup-hours" style="color: ${q.colorHex}">${q.text}: ${hours}h</div>`;
                    }
                });
                content += `</div>`;
            }

            // Morning section
            const morningQuestions = questions.filter(q => q.section === 'morning');
            if (morningQuestions.length > 0) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title">${SUN_ICON}<span>Morning Checklist</span></div>`;
                morningQuestions.forEach(q => {
                    const answer = entry[q.text];
                    const className = answer === 'yes' ? 'yes' : 'no';
                    content += `<div class="popup-item ${className}" style="color: ${q.colorHex}">${q.text} ${answer === 'yes' ? '✓' : '✗'}</div>`;
                });
                content += `</div>`;
            }

            // Evening section
            const eveningQuestions = questions.filter(q => q.section === 'evening');
            if (eveningQuestions.length > 0) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title">${MOON_ICON}<span>Evening Checklist</span></div>`;
                eveningQuestions.forEach(q => {
                    const answer = entry[q.text];
                    const className = answer === 'yes' ? 'yes' : 'no';
                    content += `<div class="popup-item ${className}" style="color: ${q.colorHex}">${q.text} ${answer === 'yes' ? '✓' : '✗'}</div>`;
                });
                content += `</div>`;
            }

            // Daily section
            const dailyQuestions = questions.filter(q => q.section === 'daily');
            if (dailyQuestions.length > 0) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title"><span>Daily Checklist</span></div>`;
                dailyQuestions.forEach(q => {
                    const answer = entry[q.text];
                    const className = answer === 'yes' ? 'yes' : 'no';
                    content += `<div class="popup-item ${className}" style="color: ${q.colorHex}">${q.text} ${answer === 'yes' ? '✓' : '✗'}</div>`;
                });
                content += `</div>`;
            }

            document.getElementById('popupContent').innerHTML = content;
            document.getElementById('dataPopup').classList.add('active');
        }

        function closeDataPopup() {
            document.getElementById('dataPopup').classList.remove('active');
        }

        // ============================================
        // CHART
        // ============================================
        function updateChart() {
            const canvas = document.getElementById('myChart');
            const ctx = canvas.getContext('2d');

            // Filter data
            let filteredData = [...quizData].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (!showAllData && filteredData.length > 0) {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                filteredData = filteredData.filter(entry => new Date(entry.timestamp) >= thirtyDaysAgo);
            }

            let chartData;
            
            if (chartMode === 'percent') {
                // Build percentage chart data
                chartData = filteredData.map(entry => {
                    const timestamp = new Date(entry.timestamp);

                    const cyanQuestions = questions.filter(q => q.color === 'C' && q.type === 'yesno');
                    const magentaQuestions = questions.filter(q => q.color === 'M' && q.type === 'yesno');
                    const yellowQuestions = questions.filter(q => q.color === 'Y' && q.type === 'yesno');

                    const cyanYes = cyanQuestions.filter(q => entry[q.text] === 'yes').length;
                    const magentaYes = magentaQuestions.filter(q => entry[q.text] === 'yes').length;
                    const yellowYes = yellowQuestions.filter(q => entry[q.text] === 'yes').length;

                    const cyanPercent = cyanQuestions.length > 0 ? (cyanYes / cyanQuestions.length) * 100 : 0;
                    const magentaPercent = magentaQuestions.length > 0 ? (magentaYes / magentaQuestions.length) * 100 : 0;
                    const yellowPercent = yellowQuestions.length > 0 ? (yellowYes / yellowQuestions.length) * 100 : 0;

                    const rating = parseFloat(entry['daily rating']);
                    let ratingPercent = isNaN(rating) || entry['daily rating'] === '' ? null : ((rating + 2) / 4) * 100;

                    const hasSubstanceUse = 
                        entry['nicotine free ?'] === 'no' || 
                        entry['cannabis free ?'] === 'no' || 
                        entry['alcohol free?'] === 'no';

                    return {
                        x: timestamp,
                        originalTimestamp: entry.timestamp,
                        cyan: cyanPercent,
                        magenta: magentaPercent,
                        yellow: yellowPercent,
                        rating: ratingPercent,
                        hasSubstanceUse: hasSubstanceUse
                    };
                });
            } else {
                // Build hours chart data
                chartData = filteredData.map(entry => {
                    const timestamp = new Date(entry.timestamp);

                    const pinkHours = parseFloat(entry['pinkProportion Hours']) || 0;
                    const studioHours = parseFloat(entry['Forma Rosa Studio Hours']) || 0;
                    const creativeHours = parseFloat(entry['Forma Rosa Creative Hours']) || 0;
                    const healthHours = parseFloat(entry['health']) || 0;

                    // Convert rating to 0-24 scale for overlay
                    const rating = parseFloat(entry['daily rating']);
                    let ratingScaled = isNaN(rating) || entry['daily rating'] === '' ? null : ((rating + 2) / 4) * 24;

                    return {
                        x: timestamp,
                        originalTimestamp: entry.timestamp,
                        magenta: pinkHours,
                        cyan: studioHours,
                        yellow: creativeHours,
                        white: healthHours,
                        rating: ratingScaled
                    };
                });
            }

            if (chart) {
                chart.destroy();
            }

            // Substance line plugin (only for percent mode)
            const substanceLinePlugin = {
                id: 'substanceLines',
                beforeDatasetsDraw(chart) {
                    if (chartMode !== 'percent') return;
                    
                    const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
                    const dataset = chart.data.datasets[0];

                    dataset.data.forEach((point, index) => {
                        const dataPoint = chartData[index];
                        if (dataPoint) {
                            const xPos = x.getPixelForValue(point.x);
                            
                            // Draw red line for harmful substances
                            if (dataPoint.hasSubstanceUse) {
                                ctx.save();
                                ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(xPos, top);
                                ctx.lineTo(xPos, bottom);
                                ctx.stroke();
                                ctx.restore();
                            }
                            
                            // Draw green line for nootropics
                            if (dataPoint.hasNootropics) {
                                ctx.save();
                                ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(xPos, top);
                                ctx.lineTo(xPos, bottom);
                                ctx.stroke();
                                ctx.restore();
                            }
                        }
                    });
                }
            };

            const yAxisConfig = chartMode === 'percent' ? {
                min: -5,
                max: 105,
                ticks: {
                    color: '#FFFFFF',
                    font: { size: 10 },
                    callback: function(value) {
                        if (value === 0 || value === 25 || value === 50 || value === 75 || value === 100) {
                            return value;
                        }
                        return '';
                    }
                },
                grid: {
                    color: function(context) {
                        const value = context.tick.value;
                        if (value === 0 || value === 25 || value === 50 || value === 75 || value === 100) {
                            return '#333333';
                        }
                        return 'transparent';
                    }
                }
            } : {
                min: 0,
                max: 24,
                ticks: {
                    color: '#FFFFFF',
                    font: { size: 10 },
                    stepSize: 4,
                    callback: function(value) {
                        if (value % 4 === 0) {
                            return value;
                        }
                        return '';
                    }
                },
                grid: {
                    color: function(context) {
                        const value = context.tick.value;
                        if (value % 4 === 0) {
                            return '#333333';
                        }
                        return 'transparent';
                    }
                }
            };

            const datasets = chartMode === 'percent' ? [
                {
                    label: 'Cyan',
                    data: chartData.map(d => ({ x: d.x, y: d.cyan })),
                    borderColor: '#00FFFF',
                    backgroundColor: '#00FFFF',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: false
                },
                {
                    label: 'Magenta',
                    data: chartData.map(d => ({ x: d.x, y: d.magenta })),
                    borderColor: '#FF00FF',
                    backgroundColor: '#FF00FF',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: false
                },
                {
                    label: 'Yellow',
                    data: chartData.map(d => ({ x: d.x, y: d.yellow })),
                    borderColor: '#FFFF00',
                    backgroundColor: '#FFFF00',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: false
                },
                {
                    label: 'Rating',
                    data: chartData.map(d => ({ x: d.x, y: d.rating })),
                    borderColor: '#FFFFFF',
                    backgroundColor: '#FFFFFF',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: false
                }
            ] : [
                {
                    label: 'pinkProportion',
                    data: chartData.map(d => ({ x: d.x, y: d.magenta })),
                    backgroundColor: '#FF00FF',
                    borderColor: '#FF00FF',
                    borderWidth: 1,
                    type: 'bar',
                    stack: 'hours',
                    barPercentage: 0.7
                },
                {
                    label: 'Studio',
                    data: chartData.map(d => ({ x: d.x, y: d.cyan })),
                    backgroundColor: '#00FFFF',
                    borderColor: '#00FFFF',
                    borderWidth: 1,
                    type: 'bar',
                    stack: 'hours',
                    barPercentage: 0.7
                },
                {
                    label: 'Creative',
                    data: chartData.map(d => ({ x: d.x, y: d.yellow })),
                    backgroundColor: '#FFFF00',
                    borderColor: '#FFFF00',
                    borderWidth: 1,
                    type: 'bar',
                    stack: 'hours',
                    barPercentage: 0.7
                },
                {
                    label: 'Health',
                    data: chartData.map(d => ({ x: d.x, y: d.white })),
                    backgroundColor: '#FFFFFF',
                    borderColor: '#FFFFFF',
                    borderWidth: 1,
                    type: 'bar',
                    stack: 'hours',
                    barPercentage: 0.7
                },
                {
                    label: 'Daily Rating',
                    data: chartData.map(d => ({ x: d.x, y: d.rating })),
                    borderColor: '#FFFFFF',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    type: 'line',
                    spanGaps: false,
                    order: 0
                }
            ];

            chart = new Chart(ctx, {
                type: chartMode === 'percent' ? 'line' : 'bar',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const timestamp = chartData[dataIndex].originalTimestamp;
                            showDataPopup(timestamp);
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ...yAxisConfig,
                            stacked: chartMode === 'hours'
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                stepSize: 6,
                                displayFormats: {
                                    hour: 'M-d-yy'
                                },
                                tooltipFormat: 'MMM d, h:mm a'
                            },
                            ticks: {
                                source: 'data',
                                color: '#FFFFFF',
                                font: { size: 8 },
                                maxRotation: 90,
                                minRotation: 90
                            },
                            grid: {
                                color: '#333333'
                            },
                            stacked: chartMode === 'hours'
                        }
                    }
                },
                plugins: [substanceLinePlugin]
            });
        }

        // ============================================
        // QUIZ
        // ============================================
        function startQuiz() {
            currentQuestionIndex = 0;
            responses = {};
            showScreen('quizScreen');
            renderQuestion();
            initCardDragHandlers();
        }

        function initCardDragHandlers() {
            const card = document.getElementById('card');
            if (!card) return;

            card.removeEventListener('mousedown', startDrag);
            card.removeEventListener('touchstart', startDrag);

            card.addEventListener('mousedown', startDrag);
            card.addEventListener('touchstart', startDrag, { passive: false });

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function renderQuestion() {
            const question = questions[currentQuestionIndex];
            const card = document.getElementById('card');
            const sectionLabel = document.getElementById('sectionLabel');
            const cardContent = document.getElementById('cardContent');
            const progressBar = document.getElementById('progressBar');

            // Stop recording if moving away from text card
            if (question.type !== 'text') {
                stopRecording();
            }

            card.style.backgroundColor = '#0D0D0D';
            card.style.borderColor = question.colorHex;
            card.style.transform = 'none';

            // Section label with icon
            let icon = '';
            if (question.section === 'morning') icon = SUN_ICON;
            else if (question.section === 'evening') icon = MOON_ICON;

            sectionLabel.innerHTML = icon + `<span>${SECTION_LABELS[question.section]}</span>`;
            sectionLabel.style.color = question.colorHex;

            const progress = (currentQuestionIndex / questions.length) * 100;
            progressBar.style.width = `${progress}%`;

            if (question.type === 'yesno') {
                cardContent.innerHTML = `<div class="question-text" style="color: ${question.colorHex}">${question.text}</div>`;
            } else if (question.type === 'text') {
                cardContent.innerHTML = `
                    <div class="text-input-container">
                        <textarea 
                            id="textInput" 
                            class="text-input" 
                            placeholder="tap to type or use microphone..."
                        ></textarea>
                        <div class="input-controls">
                            <button id="micBtn" class="mic-btn" onclick="toggleRecording()">
                                ${MIC_ICON}
                                <span>record</span>
                            </button>
                            <button class="submit-btn" onclick="submitText()">
                                submit
                            </button>
                        </div>
                    </div>
                `;
            } else if (question.type === 'rating') {
                const values = [2, 1, 0, -1, -2];
                cardContent.innerHTML = `<div class="rating-container">
                    ${values.map(val => `
                        <div class="rating-circle" 
                             data-value="${val}"
                             style="border-color: ${question.colorHex}; color: ${question.colorHex};"
                             onclick="selectRating(${val})">
                            ${val > 0 ? '+' + val : val}
                        </div>
                    `).join('')}
                </div>`;
            } else if (question.type === 'hours') {
                cardContent.innerHTML = `
                    <div class="slider-container">
                        <div class="slider-value" id="sliderValue" style="color: ${question.colorHex}">0</div>
                        <div class="slider-wrapper">
                            <input 
                                type="range" 
                                min="0" 
                                max="12" 
                                value="0" 
                                class="hour-slider" 
                                id="hourSlider"
                                style="background: linear-gradient(to right, ${question.colorHex} 0%, #1A1A1A 0%);"
                                oninput="updateSliderValue(this.value, '${question.colorHex}')"
                            />
                            <div class="slider-labels">
                                <span>0</span>
                                <span>12</span>
                            </div>
                        </div>
                        <button 
                            class="slider-submit" 
                            style="border-color: ${question.colorHex}; color: ${question.colorHex};"
                            onclick="submitHours()"
                        >
                            submit
                        </button>
                    </div>
                `;
                
                // Set thumb color
                const style = document.createElement('style');
                style.textContent = `
                    #hourSlider::-webkit-slider-thumb { background: ${question.colorHex}; }
                    #hourSlider::-moz-range-thumb { background: ${question.colorHex}; }
                `;
                document.head.appendChild(style);
            }
        }

        function updateSliderValue(value, color) {
            document.getElementById('sliderValue').textContent = value;
            const slider = document.getElementById('hourSlider');
            const percentage = (value / 12) * 100;
            slider.style.background = `linear-gradient(to right, ${color} ${percentage}%, #1A1A1A ${percentage}%)`;
        }

        function submitHours() {
            const slider = document.getElementById('hourSlider');
            const value = parseInt(slider.value);
            const question = questions[currentQuestionIndex];
            
            responses[question.text] = value;
            
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                completeQuiz();
            }
        }

        function toggleRecording() {
            if (!recognition) {
                alert('Speech recognition not supported on this device');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) return;

            try {
                recognition.start();
                isRecording = true;
                const micBtn = document.getElementById('micBtn');
                if (micBtn) {
                    micBtn.classList.add('recording');
                    micBtn.innerHTML = `${MIC_ICON}<span>recording...</span>`;
                }
            } catch (error) {
                console.error('Failed to start recording:', error);
            }
        }

        function stopRecording() {
            if (!recognition || !isRecording) return;

            try {
                recognition.stop();
            } catch (error) {
                console.error('Failed to stop recording:', error);
            }

            isRecording = false;
            const micBtn = document.getElementById('micBtn');
            if (micBtn) {
                micBtn.classList.remove('recording');
                micBtn.innerHTML = `${MIC_ICON}<span>record</span>`;
            }
        }

        function submitText() {
            const textInput = document.getElementById('textInput');
            if (!textInput) return;

            const text = textInput.value.trim();

            if (!text) {
                alert('Please enter a response');
                return;
            }

            stopRecording();

            const question = questions[currentQuestionIndex];
            responses[question.text] = text;

            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                completeQuiz();
            }
        }

        function selectRating(value) {
            const question = questions[currentQuestionIndex];

            // CRITICAL: Save as number, not string
            responses[question.text] = Number(value);

            const circles = document.querySelectorAll('.rating-circle');
            circles.forEach(circle => {
                const circleValue = parseInt(circle.dataset.value);
                // Fill circles from bottom up (all values <= selected value)
                if (circleValue <= value) {
                    circle.style.backgroundColor = '#FF00FF';
                    circle.style.color = '#0D0D0D';
                } else {
                    circle.style.backgroundColor = 'transparent';
                    circle.style.color = question.colorHex;
                }
            });

            // Auto-complete quiz after rating selection
            setTimeout(() => {
                completeQuiz();
            }, 300);
        }

        function handleAnswer(answer) {
            const question = questions[currentQuestionIndex];

            if (question.type === 'yesno') {
                responses[question.text] = answer;
            }

            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                completeQuiz();
            }
        }

        async function completeQuiz() {
            const timestamp = new Date().toISOString();
            const data = {
                timestamp,
                ...responses
            };

            await saveToSheet(data);
            showScreen('chartScreen');
        }

        // ============================================
        // DRAG HANDLERS
        // ============================================
        function startDrag(e) {
            const question = questions[currentQuestionIndex];
            if (question.type === 'rating' || question.type === 'text' || question.type === 'hours') return;

            e.preventDefault();
            isDragging = true;
            dragStartX = e.touches ? e.touches[0].clientX : e.clientX;
            dragOffset = 0;

            const card = document.getElementById('card');
            if (card) card.classList.add('dragging');
        }

        function drag(e) {
            if (!isDragging) return;

            const question = questions[currentQuestionIndex];
            const currentX = e.touches ? e.touches[0].clientX : e.clientX;
            dragOffset = currentX - window.innerWidth / 2;

            const rotation = dragOffset * 0.1;
            const shouldShowColor = dragOffset > 100;

            const card = document.getElementById('card');
            if (!card) return;

            card.style.transform = `translateX(${dragOffset}px) rotate(${rotation}deg)`;

            if (shouldShowColor) {
                card.style.backgroundColor = question.colorHex;
                const textElements = card.querySelectorAll('.section-label, .question-text');
                textElements.forEach(el => el.style.color = '#0D0D0D');
            } else {
                card.style.backgroundColor = '#0D0D0D';
                const textElements = card.querySelectorAll('.section-label, .question-text');
                textElements.forEach(el => el.style.color = question.colorHex);
            }
        }

        function endDrag() {
            if (!isDragging) return;

            const card = document.getElementById('card');
            if (!card) return;

            if (Math.abs(dragOffset) > 100) {
                if (dragOffset > 0) {
                    handleAnswer('yes');
                } else {
                    handleAnswer('no');
                }
            } else {
                card.style.transform = 'none';
                card.style.backgroundColor = '#0D0D0D';
                const question = questions[currentQuestionIndex];
                const textElements = card.querySelectorAll('.section-label, .question-text');
                textElements.forEach(el => el.style.color = question.colorHex);
            }

            isDragging = false;
            dragOffset = 0;
            card.classList.remove('dragging');
        }
    </script>
</body>
</html>
