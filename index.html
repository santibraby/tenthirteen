<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0D0D0D">
    <title>10:13</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Karla:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Karla', sans-serif;
            background-color: #0D0D0D;
            color: #FFFFFF;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .logo {
            font-size: 48px;
            font-weight: 700;
            text-transform: lowercase;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00FFFF, #FF00FF, #FFFF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version {
            font-size: 14px;
            color: #666;
            margin-bottom: 40px;
            text-transform: lowercase;
        }

        .btn {
            background-color: #FFFFFF;
            color: #0D0D0D;
            border: none;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            max-width: 300px;
            transition: opacity 0.3s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Chart Screen */
        .chart-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .chart-screen.active {
            display: block;
        }

        .chart-wrapper {
            width: 100%;
            height: 100%;
            padding: 20px;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
            text-transform: lowercase;
            cursor: pointer;
            background: linear-gradient(45deg, #00FFFF, #FF00FF, #FFFF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .toggle {
            display: flex;
            align-items: center;
            background-color: #1A1A1A;
            border-radius: 20px;
            padding: 4px;
        }

        .toggle-btn {
            background-color: transparent;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background-color: #FFFFFF;
            color: #0D0D0D;
        }

        .chart-container {
            flex: 1;
            position: relative;
            padding: 0 20px 60px 20px;
            min-height: 0;
            height: calc(100% - 80px);
        }

        .view-toggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: #1A1A1A;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .view-btn {
            background-color: transparent;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s;
        }

        .view-btn.active {
            background-color: #FFFFFF;
            color: #0D0D0D;
        }

        /* Quiz Screen */
        .quiz-screen {
            display: none;
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .quiz-screen.active {
            display: block;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 6px;
            background: linear-gradient(90deg, #00FFFF, #FF00FF, #FFFF00);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }

        .card-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .card {
            width: 100%;
            max-width: 400px;
            height: 60%;
            border-radius: 16px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: grab;
            user-select: none;
            transition: all 0.3s ease;
            border: 2px solid;
            background-color: #0D0D0D;
        }

        .card.dragging {
            cursor: grabbing;
            transition: none;
        }

        .section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            text-transform: lowercase;
            font-weight: 700;
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        .question-text {
            font-size: 48px;
            font-weight: 700;
            text-transform: lowercase;
            line-height: 1.2;
            text-align: center;
            word-break: break-word;
        }

        .rating-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            flex: 1;
            justify-content: center;
        }

        .rating-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.2s;
            background-color: transparent;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            flex: 1;
            justify-content: center;
        }

        .slider-value {
            font-size: 72px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .slider-wrapper {
            width: 100%;
            max-width: 350px;
        }

        .hour-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            background: #1A1A1A;
        }

        .hour-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
        }

        .hour-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .slider-submit {
            background-color: transparent;
            border: 2px solid;
            padding: 12px 32px;
            border-radius: 8px;
            font-family: 'Karla', sans-serif;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            text-transform: lowercase;
            transition: all 0.2s;
        }

        .slider-submit:active {
            transform: scale(0.95);
        }

        .text-input-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
            justify-content: center;
        }

        .text-input {
            width: 100%;
            min-height: 150px;
            background-color: transparent;
            border: 2px solid #FFFFFF;
            border-radius: 8px;
            padding: 16px;
            color: #FFFFFF;
            font-family: 'Karla', sans-serif;
            font-size: 16px;
            font-weight: 700;
            resize: none;
            outline: none;
        }

        .text-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .mic-btn, .submit-btn {
            background-color: transparent;
            border: 2px solid #FFFFFF;
            color: #FFFFFF;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: 'Karla', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .mic-btn:active, .submit-btn:active {
            background-color: #FFFFFF;
            color: #0D0D0D;
        }

        .mic-btn.recording {
            background-color: #FF0000;
            border-color: #FF0000;
            color: #FFFFFF;
        }

        /* Data Popup */
        .data-popup {
            position: fixed;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            background-color: #0D0D0D;
            border: 2px solid #FFFFFF;
            border-radius: 16px;
            padding: 32px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .data-popup.active {
            display: block;
        }

        .popup-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 20px;
            text-transform: lowercase;
        }

        .popup-section {
            margin-bottom: 24px;
        }

        .popup-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: lowercase;
        }

        .popup-item {
            margin-left: 28px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .popup-item.yes {
            opacity: 1;
        }

        .popup-item.no {
            opacity: 0.3;
        }

        .popup-response {
            background-color: #1A1A1A;
            border: 2px solid #FFFFFF;
            border-radius: 8px;
            padding: 16px;
            color: #FFFFFF;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 8px;
            white-space: pre-wrap;
        }

        .popup-rating {
            font-size: 48px;
            font-weight: 700;
            color: #FFFFFF;
            text-align: center;
            margin: 16px 0;
        }

        .popup-hours {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin: 12px 0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="logo">10:13</div>
        <!-- UPDATE VERSION NUMBER HERE when artifact changes -->
        <div class="version">v27</div>
        <button class="btn" onclick="handleLogin()">sign in with google</button>
    </div>

    <!-- Chart Screen -->
    <div id="chartScreen" class="chart-screen">
        <div class="chart-wrapper">
            <div class="header">
                <div class="title" onclick="startQuiz()">10:13</div>
                <div class="toggle">
                    <button class="toggle-btn active" id="toggle30d" onclick="setChartView(false)">30d</button>
                    <button class="toggle-btn" id="toggleAll" onclick="setChartView(true)">all</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="myChart"></canvas>
                <div class="view-toggle">
                    <button class="view-btn active" id="viewPercent" onclick="setChartMode('percent')">%</button>
                    <button class="view-btn" id="viewHours" onclick="setChartMode('hours')">hours</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Popup -->
    <div id="dataPopup" class="data-popup">
        <div id="popupContent"></div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="quiz-screen">
        <div class="progress-bar" id="progressBar"></div>
        <div class="card-container">
            <div class="card" id="card">
                <div class="section-label" id="sectionLabel"></div>
                <div id="cardContent"></div>
                <div></div>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // ============================================
        // QUESTIONS CONFIGURATION - EDIT THIS SECTION
        // ============================================
        // ============================================
        // QUESTIONS CONFIGURATION
        // ============================================
        const QUESTIONS = [
            // Morning (m1-m11)
            { id: 'm1', section: 'morning', text: 'make bed?', color: 'M' },
            { id: 'm2', section: 'morning', text: 'brush teeth AM?', color: 'C' },
            { id: 'm3', section: 'morning', text: 'colostrum AM?', color: 'C' },
            { id: 'm4', section: 'morning', text: 'morning run?', color: 'C' },
            { id: 'm5', section: 'morning', text: 'fruit / granola / yogurt?', color: 'C' },
            { id: 'm6', section: 'morning', text: 'journal?', color: 'M' },
            { id: 'm7', section: 'morning', text: 'shower AM?', color: 'C' },
            { id: 'm8', section: 'morning', text: 'rogaine AM?', color: 'C' },
            { id: 'm9', section: 'morning', text: 'shave?', color: 'M' },
            { id: 'm10', section: 'morning', text: 'face lotion AM?', color: 'C' },
            { id: 'm11', section: 'morning', text: 'clean ear AM?', color: 'C' },
            
            // Evening (e1-e8)
            { id: 'e1', section: 'evening', text: 'colostrum PM?', color: 'C' },
            { id: 'e2', section: 'evening', text: 'body weight workout?', color: 'C' },
            { id: 'e3', section: 'evening', text: 'shower / bath PM?', color: 'C' },
            { id: 'e4', section: 'evening', text: 'rogaine PM?', color: 'C' },
            { id: 'e5', section: 'evening', text: 'face lotion PM?', color: 'C' },
            { id: 'e6', section: 'evening', text: 'clean ear PM?', color: 'C' },
            { id: 'e7', section: 'evening', text: 'brush teeth PM?', color: 'C' },
            { id: 'e8', section: 'evening', text: 'read?', color: 'M' },
            
            // Daily substances (d1-d5)
            { id: 'd1', section: 'daily', text: 'nicotine free?', color: 'M', substanceType: 'harmful' },
            { id: 'd2', section: 'daily', text: 'cannabis free?', color: 'M', substanceType: 'harmful' },
            { id: 'd3', section: 'daily', text: 'alcohol free?', color: 'M', substanceType: 'harmful' },
            { id: 'd4', section: 'daily', text: 'caffeine?', color: 'M' },
            { id: 'd5', section: 'daily', text: 'nootropics?', color: 'M', substanceType: 'nootropic' },
            
            // Daily social (d6-d8)
            { id: 'd6', section: 'daily', text: 'connect with friends?', color: 'Y' },
            { id: 'd7', section: 'daily', text: 'connect with family?', color: 'Y' },
            { id: 'd8', section: 'daily', text: 'quality time with Maria?', color: 'Y' },
            
            // Hours (h1-h4)
            { id: 'h1', section: 'hours', text: 'pinkProportion hours', color: 'M' },
            { id: 'h2', section: 'hours', text: 'forma rosa studio hours', color: 'C' },
            { id: 'h3', section: 'hours', text: 'forma rosa creative hours', color: 'Y' },
            { id: 'h4', section: 'hours', text: 'health hours', color: 'W' },
            
            // Text and rating
            { id: 'text', section: 'text', text: 'daily response', color: 'W' },
            { id: 'rating', section: 'rating', text: 'daily rating', color: 'W' }
        ];

        // ============================================
        // APP CONFIGURATION
        // ============================================
        const CLIENT_ID = '785091900263-bqe75ticj4pr0uovtb1b0c5d8ogpnvm8.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1JfphEjMpGi16ALOGdbLIu5II1Ns5eRjUxdUb9HLTFu8';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        const COLOR_MAP = {
            'C': '#00FFFF',  // Cyan
            'M': '#FF00FF',  // Magenta
            'Y': '#FFFF00',  // Yellow
            'W': '#FFFFFF'   // White
        };

        const SECTION_LABELS = {
            'morning': 'Morning Checklist',
            'evening': 'Evening Checklist',
            'daily': 'Daily Checklist',
            'hours': 'Hours Tracking',
            'text': 'Daily Response',
            'rating': 'Daily Rating'
        };

        // SVG Icons
        const SUN_ICON = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
        
        const MOON_ICON = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
        
        const MIC_ICON = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';

        // ============================================
        // APP STATE
        // ============================================
        let accessToken = null;
        let tokenClient = null;
        let currentQuestionIndex = 0;
        let responses = {};
        let dragStartX = 0;
        let dragOffset = 0;
        let isDragging = false;
        let showAllData = false;
        let chartMode = 'percent'; // 'percent' or 'hours'
        let quizData = [];
        let chart = null;
        let recognition = null;
        let isRecording = false;
        let isAuthInitialized = false;

        // Process questions to add type information
        const questions = QUESTIONS.map(q => {
            let type = 'yesno';
            if (q.section === 'rating') type = 'rating';
            if (q.section === 'text') type = 'text';
            if (q.section === 'hours') type = 'hours';
            
            return {
                ...q,
                type: type
            };
        });

        // ============================================
        // GOOGLE AUTH
        // ============================================
        function initializeGoogleAuth() {
            const loginBtn = document.querySelector('.btn');
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.textContent = 'loading...';
            }

            // Wait for google.accounts to be available
            const waitForGoogleAPIs = setInterval(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    clearInterval(waitForGoogleAPIs);
                    initializeAPIs();
                }
            }, 100);
        }

        function initializeAPIs() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: async (response) => {
                        if (response.error) {
                            console.error('Auth error:', response.error);
                            alert('Authentication failed. Please try again.');
                            return;
                        }
                        accessToken = response.access_token;
                        await loadSheetData();
                        showScreen('chartScreen');
                    }
                });

                isAuthInitialized = true;
                
                // Enable the login button
                const loginBtn = document.querySelector('.btn');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'sign in with google';
                }

                console.log('Google Auth initialized successfully');
            } catch (error) {
                console.error('Error initializing Google Auth:', error);
                const loginBtn = document.querySelector('.btn');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'sign in with google (retry)';
                }
            }
        }

        // Make handleLogin globally accessible
        window.handleLogin = function() {
            if (!isAuthInitialized || !tokenClient) {
                alert('Authentication is still loading. Please wait a moment and try again.');
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        async function loadSheetData() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A:ZZ`,
                    {
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        }
                    }
                );

                const data = await response.json();

                if (data.values && data.values.length > 1) {
                    const headers = data.values[0];
                    quizData = data.values.slice(1).map(row => {
                        const entry = {};
                        headers.forEach((header, index) => {
                            entry[header] = row[index] || '';
                        });
                        return entry;
                    });
                } else {
                    quizData = [];
                }

                updateChart();
            } catch (error) {
                console.error('Error loading sheet data:', error);
                quizData = [];
                updateChart();
            }
        }

        async function saveToSheet(data) {
            try {
                // Get existing headers
                const checkResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!1:1`,
                    {
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        }
                    }
                );

                const checkData = await checkResponse.json();
                let existingHeaders = checkData.values?.[0] || [];

                // Build expected headers: timestamp + all question IDs
                const expectedHeaders = ['timestamp', ...questions.map(q => q.id)];

                // Merge headers: keep all existing + add any new ones
                const mergedHeaders = [...existingHeaders];
                expectedHeaders.forEach(header => {
                    if (!mergedHeaders.includes(header)) {
                        mergedHeaders.push(header);
                    }
                });

                // If headers changed, update the header row
                if (mergedHeaders.length !== existingHeaders.length || existingHeaders.length === 0) {
                    console.log('Updating headers:', mergedHeaders);
                    await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!1:1?valueInputOption=RAW`,
                        {
                            method: 'PUT',
                            headers: {
                                Authorization: `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                values: [mergedHeaders]
                            })
                        }
                    );
                }

                // Build data row matching merged headers
                const row = mergedHeaders.map(header => {
                    if (data[header] !== undefined) {
                        return data[header];
                    }
                    return '';
                });

                // Append data row
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A:ZZ:append?valueInputOption=RAW`,
                    {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            values: [row]
                        })
                    }
                );

                console.log('Data saved successfully');
                await loadSheetData();
            } catch (error) {
                console.error('Error saving to sheet:', error);
            }
        }

        // ============================================
        // UI NAVIGATION
        // ============================================
        function showScreen(screenId) {
            // Clean up when leaving quiz
            if (screenId !== 'quizScreen') {
                stopRecording();
                responses = {};
            }

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('chartScreen').classList.remove('active');
            document.getElementById('quizScreen').classList.remove('active');

            if (screenId === 'chartScreen') {
                document.getElementById('chartScreen').classList.add('active');
            } else if (screenId === 'quizScreen') {
                document.getElementById('quizScreen').classList.add('active');
            } else {
                document.getElementById(screenId).classList.remove('hidden');
            }
        }

        function setChartView(showAll) {
            showAllData = showAll;
            document.getElementById('toggle30d').classList.toggle('active', !showAll);
            document.getElementById('toggleAll').classList.toggle('active', showAll);
            updateChart();
        }

        function setChartMode(mode) {
            chartMode = mode;
            document.getElementById('viewPercent').classList.toggle('active', mode === 'percent');
            document.getElementById('viewHours').classList.toggle('active', mode === 'hours');
            updateChart();
        }

        // ============================================
        // DATA POPUP
        // ============================================
        function initPopupDragHandlers() {
            const popup = document.getElementById('dataPopup');
            let popupDragStartX = 0;
            let popupDragOffset = 0;
            let popupIsDragging = false;

            const startPopupDrag = (e) => {
                if (e.target.id === 'dataPopup') {
                    popupIsDragging = true;
                    popupDragStartX = e.touches ? e.touches[0].clientX : e.clientX;
                    popupDragOffset = 0;
                }
            };

            const popupDrag = (e) => {
                if (!popupIsDragging) return;
                const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                popupDragOffset = currentX - popupDragStartX;
            };

            const endPopupDrag = () => {
                if (!popupIsDragging) return;

                if (Math.abs(popupDragOffset) > 100) {
                    closeDataPopup();
                }

                popupIsDragging = false;
                popupDragOffset = 0;
            };

            popup.addEventListener('touchstart', startPopupDrag, { passive: false });
            popup.addEventListener('touchmove', popupDrag, { passive: false });
            popup.addEventListener('touchend', endPopupDrag);
            popup.addEventListener('mousedown', startPopupDrag);
            document.addEventListener('mousemove', popupDrag);
            document.addEventListener('mouseup', endPopupDrag);
        }

        function showDataPopup(timestamp) {
            const entry = quizData.find(e => e.timestamp === timestamp);
            if (!entry) return;

            const popup = document.getElementById('dataPopup');
            const content = document.getElementById('popupContent');

            let html = `<div class="popup-timestamp">${new Date(timestamp).toLocaleString()}</div>`;

            // Group questions by section
            const sections = {};
            questions.forEach(q => {
                if (!sections[q.section]) {
                    sections[q.section] = [];
                }
                sections[q.section].push(q);
            });

            // Display each section
            Object.keys(sections).forEach(sectionKey => {
                html += `<div class="popup-section">`;
                html += `<div class="popup-section-title">${SECTION_LABELS[sectionKey]}</div>`;
                
                sections[sectionKey].forEach(q => {
                    const value = entry[q.id] || '-';
                    const color = COLOR_MAP[q.color];
                    
                    if (q.type === 'rating') {
                        html += `<div class="popup-item"><span class="popup-label">${q.text}:</span> <span style="color: ${color}">${value}</span></div>`;
                    } else if (q.type === 'text') {
                        html += `<div class="popup-item"><span class="popup-label">${q.text}:</span> <span style="color: ${color}">${value || 'none'}</span></div>`;
                    } else if (q.type === 'hours') {
                        html += `<div class="popup-item"><span class="popup-label">${q.text}:</span> <span style="color: ${color}">${value}h</span></div>`;
                    } else {
                        html += `<div class="popup-item"><span class="popup-label">${q.text}:</span> <span style="color: ${color}">${value}</span></div>`;
                    }
                });
                
                html += `</div>`;
            });

            content.innerHTML = html;
            popup.classList.add('active');
        }

        function closeDataPopup() {
            document.getElementById('dataPopup').classList.remove('active');
        }

        // ============================================
        // CHART RENDERING
        // ============================================
        function updateChart() {
            const canvas = document.getElementById('myChart');
            const ctx = canvas.getContext('2d');

            // Filter data by time range
            let filteredData = [...quizData].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (!showAllData && filteredData.length > 0) {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                filteredData = filteredData.filter(entry => new Date(entry.timestamp) >= thirtyDaysAgo);
            }

            let chartData;
            
            if (chartMode === 'percent') {
                // Build percentage chart data
                chartData = filteredData.map(entry => {
                    const timestamp = new Date(entry.timestamp);

                    // Dynamically filter questions by color and type
                    const cyanQuestions = questions.filter(q => q.color === 'C' && q.type === 'yesno');
                    const magentaQuestions = questions.filter(q => q.color === 'M' && q.type === 'yesno');
                    const yellowQuestions = questions.filter(q => q.color === 'Y' && q.type === 'yesno');

                    // Count "yes" responses for each color
                    const cyanYes = cyanQuestions.filter(q => entry[q.id] === 'yes').length;
                    const magentaYes = magentaQuestions.filter(q => entry[q.id] === 'yes').length;
                    const yellowYes = yellowQuestions.filter(q => entry[q.id] === 'yes').length;

                    // Calculate percentages
                    const cyanPercent = cyanQuestions.length > 0 ? (cyanYes / cyanQuestions.length) * 100 : 0;
                    const magentaPercent = magentaQuestions.length > 0 ? (magentaYes / magentaQuestions.length) * 100 : 0;
                    const yellowPercent = yellowQuestions.length > 0 ? (yellowYes / yellowQuestions.length) * 100 : 0;

                    // Convert rating to percentage scale
                    const rating = parseFloat(entry['rating']);
                    let ratingPercent = isNaN(rating) || entry['rating'] === '' ? null : ((rating + 2) / 4) * 100;

                    // Detect harmful substance use (answered "no" to "free?" questions)
                    const harmfulSubstanceQuestions = questions.filter(q => q.substanceType === 'harmful');
                    const hasSubstanceUse = harmfulSubstanceQuestions.some(q => entry[q.id] === 'no');

                    // Detect nootropics use (answered "yes")
                    const nootropicQuestions = questions.filter(q => q.substanceType === 'nootropic');
                    const hasNootropics = nootropicQuestions.some(q => entry[q.id] === 'yes');

                    return {
                        x: timestamp,
                        originalTimestamp: entry.timestamp,
                        cyan: cyanPercent,
                        magenta: magentaPercent,
                        yellow: yellowPercent,
                        rating: ratingPercent,
                        hasSubstanceUse: hasSubstanceUse,
                        hasNootropics: hasNootropics
                    };
                });
            } else {
                // Build hours chart data
                chartData = filteredData.map(entry => {
                    const timestamp = new Date(entry.timestamp);

                    // Get hours from specific question IDs
                    const pinkHours = parseFloat(entry['h1']) || 0;
                    const studioHours = parseFloat(entry['h2']) || 0;
                    const creativeHours = parseFloat(entry['h3']) || 0;
                    const healthHours = parseFloat(entry['h4']) || 0;

                    // Convert rating to 0-24 scale for overlay
                    const rating = parseFloat(entry['rating']);
                    let ratingScaled = isNaN(rating) || entry['rating'] === '' ? null : ((rating + 2) / 4) * 24;

                    return {
                        x: timestamp,
                        originalTimestamp: entry.timestamp,
                        magenta: pinkHours,
                        cyan: studioHours,
                        yellow: creativeHours,
                        white: healthHours,
                        rating: ratingScaled
                    };
                });
            }

            if (chart) {
                chart.destroy();
            }

            // Substance line plugin (only for percent mode)
            const substanceLinePlugin = {
                id: 'substanceLines',
                beforeDatasetsDraw(chart) {
                    if (chartMode !== 'percent') return;
                    
                    const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
                    const dataset = chart.data.datasets[0];

                    dataset.data.forEach((point, index) => {
                        const dataPoint = chartData[index];
                        if (dataPoint) {
                            const xPos = x.getPixelForValue(point.x);
                            
                            // Draw red line for harmful substances
                            if (dataPoint.hasSubstanceUse) {
                                ctx.save();
                                ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(xPos, top);
                                ctx.lineTo(xPos, bottom);
                                ctx.stroke();
                                ctx.restore();
                            }
                            
                            // Draw green line for nootropics
                            if (dataPoint.hasNootropics) {
                                ctx.save();
                                ctx.strokeStyle = 'rgba(0, 255, 0, 0.6)';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(xPos + 3, top); // Offset slightly so both lines visible
                                ctx.lineTo(xPos + 3, bottom);
                                ctx.stroke();
                                ctx.restore();
                            }
                        }
                    });
                }
            };

            const yAxisConfig = chartMode === 'percent' ? {
                min: -5,
                max: 105,
                ticks: {
                    color: '#FFFFFF',
                    font: { size: 10 },
                    callback: function(value) {
                        if (value === 0 || value === 25 || value === 50 || value === 75 || value === 100) {
                            return value;
                        }
                        return '';
                    }
                },
                grid: {
                    color: function(context) {
                        const value = context.tick.value;
                        if (value === 0 || value === 25 || value === 50 || value === 75 || value === 100) {
                            return '#333333';
                        }
                        return 'transparent';
                    }
                }
            } : {
                min: 0,
                max: 24,
                ticks: {
                    color: '#FFFFFF',
                    font: { size: 10 },
                    callback: function(value) {
                        if (value === 0 || value === 24) {
                            return value;
                        }
                        return '';
                    }
                },
                grid: {
                    color: function(context) {
                        const value = context.tick.value;
                        if (value === 0 || value === 24) {
                            return '#333333';
                        }
                        return 'transparent';
                    }
                }
            };

            const datasets = chartMode === 'percent' ? [
                {
                    label: 'Cyan',
                    data: chartData.map(d => ({ x: d.x, y: d.cyan })),
                    borderColor: '#00FFFF',
                    backgroundColor: '#00FFFF',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: false
                },
                {
                    label: 'Magenta',
                    data: chartData.map(d => ({ x: d.x, y: d.magenta })),
                    borderColor: '#FF00FF',
                    backgroundColor: '#FF00FF',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: false
                },
                {
                    label: 'Yellow',
                    data: chartData.map(d => ({ x: d.x, y: d.yellow })),
                    borderColor: '#FFFF00',
                    backgroundColor: '#FFFF00',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: false
                },
                {
                    label: 'Rating',
                    data: chartData.map(d => ({ x: d.x, y: d.rating })),
                    borderColor: '#FFFFFF',
                    backgroundColor: '#FFFFFF',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    spanGaps: false
                }
            ] : [
                {
                    label: 'pinkProportion',
                    data: chartData.map(d => ({ x: d.x, y: d.magenta })),
                    backgroundColor: '#FF00FF',
                    borderColor: '#FF00FF',
                    borderWidth: 1,
                    type: 'bar',
                    stack: 'hours',
                    barPercentage: 0.7
                },
                {
                    label: 'Studio',
                    data: chartData.map(d => ({ x: d.x, y: d.cyan })),
                    backgroundColor: '#00FFFF',
                    borderColor: '#00FFFF',
                    borderWidth: 1,
                    type: 'bar',
                    stack: 'hours',
                    barPercentage: 0.7
                },
                {
                    label: 'Creative',
                    data: chartData.map(d => ({ x: d.x, y: d.yellow })),
                    backgroundColor: '#FFFF00',
                    borderColor: '#FFFF00',
                    borderWidth: 1,
                    type: 'bar',
                    stack: 'hours',
                    barPercentage: 0.7
                },
                {
                    label: 'Health',
                    data: chartData.map(d => ({ x: d.x, y: d.white })),
                    backgroundColor: '#FFFFFF',
                    borderColor: '#FFFFFF',
                    borderWidth: 1,
                    type: 'bar',
                    stack: 'hours',
                    barPercentage: 0.7
                },
                {
                    label: 'Daily Rating',
                    data: chartData.map(d => ({ x: d.x, y: d.rating })),
                    borderColor: '#FFFFFF',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    type: 'line',
                    spanGaps: false,
                    order: 0
                }
            ];

            chart = new Chart(ctx, {
                type: chartMode === 'percent' ? 'line' : 'bar',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const timestamp = chartData[dataIndex].originalTimestamp;
                            showDataPopup(timestamp);
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ...yAxisConfig,
                            stacked: chartMode === 'hours'
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                stepSize: 6,
                                displayFormats: {
                                    hour: 'M-d-yy'
                                },
                                tooltipFormat: 'MMM d, h:mm a'
                            },
                            ticks: {
                                source: 'data',
                                color: '#FFFFFF',
                                font: { size: 10 },
                                maxRotation: 90,
                                minRotation: 90
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                },
                plugins: [substanceLinePlugin]
            });
        }

        // ============================================
        // QUIZ LOGIC
        // ============================================
        function startQuiz() {
            currentQuestionIndex = 0;
            responses = {};
            showScreen('quizScreen');
            renderQuestion();
            initCardDragHandlers();
        }

        function initCardDragHandlers() {
            const card = document.getElementById('card');
            if (!card) return;

            card.removeEventListener('mousedown', startDrag);
            card.removeEventListener('touchstart', startDrag);

            card.addEventListener('mousedown', startDrag);
            card.addEventListener('touchstart', startDrag, { passive: false });

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function renderQuestion() {
            const question = questions[currentQuestionIndex];
            const card = document.getElementById('card');
            const sectionLabel = document.getElementById('sectionLabel');
            const cardContent = document.getElementById('cardContent');
            const progressBar = document.getElementById('progressBar');

            // Stop recording if moving away from text card
            if (question.type !== 'text') {
                stopRecording();
            }

            card.style.backgroundColor = '#0D0D0D';
            card.style.borderColor = COLOR_MAP[question.color];
            card.style.transform = 'none';

            // Section label with icon
            let icon = '';
            if (question.section === 'morning') icon = SUN_ICON;
            else if (question.section === 'evening') icon = MOON_ICON;

            sectionLabel.innerHTML = icon + `<span>${SECTION_LABELS[question.section]}</span>`;
            sectionLabel.style.color = COLOR_MAP[question.color];

            const progress = (currentQuestionIndex / questions.length) * 100;
            progressBar.style.width = `${progress}%`;

            const colorHex = COLOR_MAP[question.color];

            if (question.type === 'yesno') {
                cardContent.innerHTML = `<div class="question-text" style="color: ${colorHex}">${question.text}</div>`;
            } else if (question.type === 'text') {
                cardContent.innerHTML = `
                    <div class="text-input-container">
                        <textarea 
                            id="textInput" 
                            class="text-input" 
                            placeholder="tap to type or use microphone..."
                        ></textarea>
                        <div class="input-controls">
                            <button id="micBtn" class="mic-btn" onclick="toggleRecording()">
                                ${MIC_ICON}
                                <span>record</span>
                            </button>
                            <button class="submit-btn" onclick="submitText()">
                                submit
                            </button>
                        </div>
                    </div>
                `;
            } else if (question.type === 'rating') {
                const values = [2, 1, 0, -1, -2];
                cardContent.innerHTML = `<div class="rating-container">
                    ${values.map(val => `
                        <div class="rating-circle" 
                             data-value="${val}"
                             style="border-color: ${colorHex}; color: ${colorHex};"
                             onclick="selectRating(${val})">
                            ${val > 0 ? '+' + val : val}
                        </div>
                    `).join('')}
                </div>`;
            } else if (question.type === 'hours') {
                cardContent.innerHTML = `
                    <div class="slider-container">
                        <div class="question-text" style="color: ${colorHex}; font-size: 24px; margin-bottom: 20px;">${question.text}</div>
                        <div class="slider-value" id="sliderValue" style="color: ${colorHex}">0</div>
                        <div class="slider-wrapper">
                            <input 
                                type="range" 
                                min="0" 
                                max="12" 
                                value="0" 
                                class="hour-slider" 
                                id="hourSlider"
                                style="background: linear-gradient(to right, ${colorHex} 0%, #1A1A1A 0%);"
                                oninput="updateSliderValue(this.value, '${colorHex}')"
                            />
                            <div class="slider-labels">
                                <span>0</span>
                                <span>6</span>
                                <span>12</span>
                            </div>
                        </div>
                        <button class="submit-btn" onclick="submitHours()" style="margin-top: 40px;">
                            submit
                        </button>
                    </div>
                `;
            }
        }

        function updateSliderValue(value, color) {
            document.getElementById('sliderValue').textContent = value;
            const slider = document.getElementById('hourSlider');
            const percentage = (value / 12) * 100;
            slider.style.background = `linear-gradient(to right, ${color} ${percentage}%, #1A1A1A ${percentage}%)`;
        }

        function submitText() {
            const textInput = document.getElementById('textInput');
            const question = questions[currentQuestionIndex];
            responses[question.id] = textInput.value.trim();
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                renderQuestion();
            } else {
                completeQuiz();
            }
        }

        function submitHours() {
            const slider = document.getElementById('hourSlider');
            const question = questions[currentQuestionIndex];
            responses[question.id] = slider.value;
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                renderQuestion();
            } else {
                completeQuiz();
            }
        }

        function selectRating(value) {
            const question = questions[currentQuestionIndex];
            const circles = document.querySelectorAll('.rating-circle');
            
            circles.forEach(circle => {
                const circleValue = parseInt(circle.getAttribute('data-value'));
                if (circleValue <= value) {
                    circle.style.backgroundColor = COLOR_MAP[question.color];
                }
            });

            responses[question.id] = value;

            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion();
                } else {
                    completeQuiz();
                }
            }, 300);
        }

        async function completeQuiz() {
            const timestamp = new Date().toISOString();
            const data = {
                timestamp,
                ...responses
            };

            await saveToSheet(data);
            showScreen('chartScreen');
        }

        // ============================================
        // DRAG HANDLERS
        // ============================================
        function startDrag(e) {
            const question = questions[currentQuestionIndex];
            if (question.type === 'rating' || question.type === 'text' || question.type === 'hours') return;

            e.preventDefault();
            isDragging = true;
            dragStartX = e.touches ? e.touches[0].clientX : e.clientX;
            dragOffset = 0;

            const card = document.getElementById('card');
            if (card) card.classList.add('dragging');
        }

        function drag(e) {
            if (!isDragging) return;

            const question = questions[currentQuestionIndex];
            const currentX = e.touches ? e.touches[0].clientX : e.clientX;
            dragOffset = currentX - window.innerWidth / 2;

            const card = document.getElementById('card');
            if (!card) return;

            const rotation = dragOffset * 0.1;
            card.style.transform = `translateX(${dragOffset}px) rotate(${rotation}deg)`;

            if (Math.abs(dragOffset) > 50) {
                if (dragOffset > 0) {
                    card.style.backgroundColor = COLOR_MAP[question.color] + '20';
                } else {
                    card.style.backgroundColor = '#1A1A1A';
                }
            } else {
                card.style.backgroundColor = '#0D0D0D';
            }
        }

        function endDrag() {
            if (!isDragging) return;

            const question = questions[currentQuestionIndex];
            const card = document.getElementById('card');
            
            if (Math.abs(dragOffset) > 150) {
                const answer = dragOffset > 0 ? 'yes' : 'no';
                responses[question.id] = answer;

                card.style.transition = 'transform 0.3s ease';
                card.style.transform = `translateX(${dragOffset > 0 ? '1000px' : '-1000px'}) rotate(${dragOffset > 0 ? '30deg' : '-30deg'})`;

                setTimeout(() => {
                    card.style.transition = '';
                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        renderQuestion();
                    } else {
                        completeQuiz();
                    }
                }, 300);
            } else {
                card.style.transform = 'none';
                card.style.backgroundColor = '#0D0D0D';
            }

            isDragging = false;
            dragOffset = 0;
            if (card) card.classList.remove('dragging');
        }

        // ============================================
        // SPEECH RECOGNITION
        // ============================================
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    const textInput = document.getElementById('textInput');
                    if (!textInput) return;

                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    textInput.value = (textInput.value + finalTranscript).trim();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                };
            }
        }

        function toggleRecording() {
            if (!recognition) {
                alert('Speech recognition not supported in this browser');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) return;

            try {
                recognition.start();
                isRecording = true;
                const micBtn = document.getElementById('micBtn');
                if (micBtn) {
                    micBtn.classList.add('recording');
                }
            } catch (error) {
                console.error('Error starting recording:', error);
            }
        }

        function stopRecording() {
            if (!recognition || !isRecording) return;

            try {
                recognition.stop();
                isRecording = false;
                const micBtn = document.getElementById('micBtn');
                if (micBtn) {
                    micBtn.classList.remove('recording');
                }
            } catch (error) {
                console.error('Error stopping recording:', error);
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = () => {
            initializeGoogleAuth();
            initPopupDragHandlers();
            initSpeechRecognition();
        };
    </script>
</body>
</html>
