<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0D0D0D">
    <title>10:13</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Karla:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Karla', sans-serif;
            background-color: #0D0D0D;
            color: #FFFFFF;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .logo {
            font-size: 48px;
            font-weight: 700;
            text-transform: lowercase;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00FFFF, #FF00FF, #FFFF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version {
            font-size: 14px;
            color: #666;
            margin-bottom: 40px;
            text-transform: lowercase;
        }

        .btn {
            background-color: #FFFFFF;
            color: #0D0D0D;
            border: none;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            max-width: 300px;
        }

        /* Chart Screen */
        .chart-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .chart-screen.active {
            display: block;
        }

        .chart-wrapper {
            width: 100%;
            height: 100%;
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
            text-transform: lowercase;
            cursor: pointer;
            background: linear-gradient(45deg, #00FFFF, #FF00FF, #FFFF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .toggle {
            display: flex;
            align-items: center;
            background-color: #1A1A1A;
            border-radius: 20px;
            padding: 4px;
        }

        .toggle-btn {
            background-color: transparent;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background-color: #FFFFFF;
            color: #0D0D0D;
        }

        .chart-container {
            flex: 1;
            position: relative;
            padding: 0 20px 60px 20px;
            min-height: 0;
        }

        .view-toggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: #1A1A1A;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .view-btn {
            background-color: transparent;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s;
        }

        .view-btn.active {
            background-color: #FFFFFF;
            color: #0D0D0D;
        }

        /* Quiz Screen */
        .quiz-screen {
            display: none;
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .quiz-screen.active {
            display: block;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 6px;
            background: linear-gradient(90deg, #00FFFF, #FF00FF, #FFFF00);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }

        .card-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .card {
            width: 100%;
            max-width: 400px;
            height: 60%;
            border-radius: 16px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: grab;
            user-select: none;
            transition: all 0.3s ease;
            border: 2px solid;
            background-color: #0D0D0D;
        }

        .card.dragging {
            cursor: grabbing;
            transition: none;
        }

        .section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            text-transform: lowercase;
            font-weight: 700;
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        .question-text {
            font-size: 48px;
            font-weight: 700;
            text-transform: lowercase;
            line-height: 1.2;
        }

        .swipe-hint {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 700;
            text-transform: lowercase;
            opacity: 0.5;
        }

        /* Hours Slider */
        .slider-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .slider-value {
            font-size: 72px;
            font-weight: 700;
            text-align: center;
        }

        .slider-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hour-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            outline: none;
        }

        .hour-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .hour-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .slider-submit {
            background-color: transparent;
            border: 2px solid;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .slider-submit:hover {
            opacity: 0.8;
        }

        /* Text Input */
        .text-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .text-input {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            font-size: 18px;
            font-family: 'Karla', sans-serif;
            background-color: #1A1A1A;
            color: #FFFFFF;
            border: 2px solid #FFFFFF;
            border-radius: 8px;
            resize: vertical;
        }

        .mic-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: transparent;
            border: 2px solid #FFFFFF;
            color: #FFFFFF;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .mic-button.recording {
            background-color: #FF0000;
            border-color: #FF0000;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .text-submit {
            background-color: transparent;
            border: 2px solid #FFFFFF;
            color: #FFFFFF;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Karla', sans-serif;
            text-transform: lowercase;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        /* Rating */
        .rating-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
        }

        .rating-circles {
            display: flex;
            gap: 20px;
        }

        .rating-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            background-color: transparent;
        }

        .rating-circle:hover {
            transform: scale(1.1);
        }

        /* Data Popup */
        .data-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            overflow-y: auto;
            z-index: 1000;
            padding: 40px 20px;
        }

        .data-popup.active {
            display: block;
        }

        .popup-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .popup-date {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            text-align: center;
        }

        .popup-section {
            margin-bottom: 30px;
        }

        .popup-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: lowercase;
            color: #666;
            margin-bottom: 15px;
        }

        .popup-rating {
            font-size: 48px;
            font-weight: 700;
            color: #FF00FF;
            text-align: center;
            margin: 20px 0;
        }

        .popup-response {
            font-size: 18px;
            line-height: 1.6;
            color: #FFFFFF;
            padding: 20px;
            background-color: #1A1A1A;
            border-radius: 8px;
        }

        .popup-hours {
            font-size: 16px;
            margin: 8px 0;
            padding-left: 20px;
        }

        .popup-item {
            font-size: 16px;
            margin: 8px 0;
            padding-left: 20px;
        }

        .popup-item.yes {
            opacity: 1;
        }

        .popup-item.no {
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="logo">10:13</div>
        <div class="version">v24</div>
        <button class="btn" onclick="handleGoogleLogin()">sign in with google</button>
    </div>

    <!-- Chart Screen -->
    <div id="chartScreen" class="chart-screen">
        <div class="chart-wrapper">
            <div class="header">
                <div class="title" onclick="startQuiz()">10:13</div>
                <div class="toggle">
                    <button id="toggle30d" class="toggle-btn active" onclick="setChartView(false)">30d</button>
                    <button id="toggleAll" class="toggle-btn" onclick="setChartView(true)">all</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="myChart"></canvas>
                <div class="view-toggle">
                    <button id="viewPercent" class="view-btn active" onclick="setChartMode('percent')">%</button>
                    <button id="viewHours" class="view-btn" onclick="setChartMode('hours')">hours</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="quiz-screen">
        <div class="card-container" id="cardContainer"></div>
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Data Popup -->
    <div id="dataPopup" class="data-popup" onclick="closeDataPopup()">
        <div class="popup-content" id="popupContent" onclick="event.stopPropagation()"></div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // ============================================
        // QUESTION CONFIGURATION WITH STABLE IDS
        // ============================================
        const QUESTIONS = [
            // Morning section (11 questions) - IDs: m1 to m11
            { id: 'm1', section: 'morning', text: 'make bed?', color: 'M' },
            { id: 'm2', section: 'morning', text: 'brush teeth AM?', color: 'C' },
            { id: 'm3', section: 'morning', text: 'colostrum AM?', color: 'C' },
            { id: 'm4', section: 'morning', text: 'morning run?', color: 'C' },
            { id: 'm5', section: 'morning', text: 'fruit / granola / yogurt?', color: 'C' },
            { id: 'm6', section: 'morning', text: 'journal?', color: 'M' },
            { id: 'm7', section: 'morning', text: 'shower AM?', color: 'C' },
            { id: 'm8', section: 'morning', text: 'rogaine AM?', color: 'C' },
            { id: 'm9', section: 'morning', text: 'shave?', color: 'M' },
            { id: 'm10', section: 'morning', text: 'face lotion AM?', color: 'C' },
            { id: 'm11', section: 'morning', text: 'clean ear AM?', color: 'C' },
            
            // Evening section (8 questions) - IDs: e1 to e8
            { id: 'e1', section: 'evening', text: 'colostrum PM?', color: 'C' },
            { id: 'e2', section: 'evening', text: 'body weight workout?', color: 'C' },
            { id: 'e3', section: 'evening', text: 'shower / bath PM?', color: 'C' },
            { id: 'e4', section: 'evening', text: 'rogaine PM?', color: 'C' },
            { id: 'e5', section: 'evening', text: 'face lotion PM?', color: 'C' },
            { id: 'e6', section: 'evening', text: 'clean ear PM?', color: 'C' },
            { id: 'e7', section: 'evening', text: 'brush teeth PM?', color: 'C' },
            { id: 'e8', section: 'evening', text: 'read?', color: 'M' },
            
            // Daily questions (8 questions) - IDs: d1 to d8
            { id: 'd1', section: 'daily', text: 'nicotine free?', color: 'M' },
            { id: 'd2', section: 'daily', text: 'cannabis free?', color: 'M' },
            { id: 'd3', section: 'daily', text: 'alcohol free?', color: 'M' },
            { id: 'd4', section: 'daily', text: 'caffeine?', color: 'M' },
            { id: 'd5', section: 'daily', text: 'nootropics?', color: 'M' },
            { id: 'd6', section: 'daily', text: 'connect with friends?', color: 'Y' },
            { id: 'd7', section: 'daily', text: 'connect with family?', color: 'Y' },
            { id: 'd8', section: 'daily', text: 'quality time with Maria?', color: 'Y' },
            
            // Hours tracking (4 sliders) - IDs: h1 to h4
            { id: 'h1', section: 'hours', text: 'pinkProportion hours', color: 'M' },
            { id: 'h2', section: 'hours', text: 'forma rosa studio hours', color: 'C' },
            { id: 'h3', section: 'hours', text: 'forma rosa creative hours', color: 'Y' },
            { id: 'h4', section: 'hours', text: 'health hours', color: 'W' },
            
            // Daily reflections (2 special questions)
            { id: 'text', section: 'text', text: 'daily response', color: 'W' },
            { id: 'rating', section: 'rating', text: 'daily rating', color: 'W' }
        ];

        // ============================================
        // APP CONFIGURATION
        // ============================================
        const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID_HERE';  // ← REPLACE THIS
        const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';  // ← REPLACE THIS
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        const COLOR_MAP = {
            'C': '#00FFFF',  // Cyan
            'M': '#FF00FF',  // Magenta
            'Y': '#FFFF00',  // Yellow
            'W': '#FFFFFF'   // White
        };

        // SVG Icons
        const SUN_ICON = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
        
        const MOON_ICON = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
        
        const MIC_ICON = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';

        // ============================================
        // APP STATE
        // ============================================
        let accessToken = null;
        let tokenClient = null;
        let currentQuestionIndex = 0;
        let responses = {};
        let dragStartX = 0;
        let dragOffset = 0;
        let isDragging = false;
        let showAllData = false;
        let chartMode = 'percent';
        let quizData = [];
        let chart = null;
        let recognition = null;
        let isRecording = false;

        // Process questions
        const questions = QUESTIONS.map(q => {
            let type = 'yesno';
            if (q.section === 'rating') type = 'rating';
            if (q.section === 'text') type = 'text';
            if (q.section === 'hours') type = 'hours';
            
            return {
                ...q,
                type: type,
                colorHex: COLOR_MAP[q.color]
            };
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        loadSheetData();
                        showScreen('chartScreen');
                    }
                },
            });

            // Initialize speech recognition
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    const textInput = document.getElementById('textInput');
                    if (textInput) {
                        textInput.value = transcript;
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                };

                recognition.onend = () => {
                    if (isRecording) {
                        stopRecording();
                    }
                };
            }

            initPopupDragHandlers();
        };

        function handleGoogleLogin() {
            tokenClient.requestAccessToken();
        }

        // ============================================
        // GOOGLE SHEETS API - NEW ID-BASED SYSTEM
        // ============================================
        async function loadSheetData() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A:ZZ`,
                    {
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        }
                    }
                );

                const data = await response.json();

                if (data.values && data.values.length > 1) {
                    const headers = data.values[0];
                    quizData = data.values.slice(1).map(row => {
                        const entry = {};
                        headers.forEach((header, index) => {
                            entry[header] = row[index] || '';
                        });
                        return entry;
                    });
                } else {
                    quizData = [];
                }

                console.log('Loaded data:', quizData.length, 'entries');
                updateChart();
            } catch (error) {
                console.error('Error loading sheet data:', error);
                quizData = [];
                updateChart();
            }
        }

        async function saveToSheet(data) {
            try {
                // Build expected headers from question IDs
                const expectedHeaders = ['timestamp', ...questions.map(q => q.id)];

                // Get existing headers
                const checkResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!1:1`,
                    {
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        }
                    }
                );

                const checkData = await checkResponse.json();
                let existingHeaders = checkData.values?.[0] || [];

                // If no headers exist, create them
                if (existingHeaders.length === 0) {
                    console.log('Creating new headers:', expectedHeaders);
                    await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!1:1?valueInputOption=RAW`,
                        {
                            method: 'PUT',
                            headers: {
                                Authorization: `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                values: [expectedHeaders]
                            })
                        }
                    );
                    existingHeaders = expectedHeaders;
                }

                // Build data row matching headers
                const row = existingHeaders.map(header => {
                    if (data[header] !== undefined) {
                        return data[header];
                    }
                    return '';
                });

                // Append data row
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A:ZZ:append?valueInputOption=RAW`,
                    {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            values: [row]
                        })
                    }
                );

                console.log('Data saved successfully');
                await loadSheetData();
            } catch (error) {
                console.error('Error saving to sheet:', error);
            }
        }

        // ============================================
        // UI NAVIGATION
        // ============================================
        function showScreen(screenId) {
            // Clean up when leaving quiz
            if (screenId !== 'quizScreen') {
                stopRecording();
                responses = {};
            }

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('chartScreen').classList.remove('active');
            document.getElementById('quizScreen').classList.remove('active');

            if (screenId === 'chartScreen') {
                document.getElementById('chartScreen').classList.add('active');
            } else if (screenId === 'quizScreen') {
                document.getElementById('quizScreen').classList.add('active');
            } else {
                document.getElementById(screenId).classList.remove('hidden');
            }
        }

        function setChartView(showAll) {
            showAllData = showAll;
            document.getElementById('toggle30d').classList.toggle('active', !showAll);
            document.getElementById('toggleAll').classList.toggle('active', showAll);
            updateChart();
        }

        function setChartMode(mode) {
            chartMode = mode;
            document.getElementById('viewPercent').classList.toggle('active', mode === 'percent');
            document.getElementById('viewHours').classList.toggle('active', mode === 'hours');
            updateChart();
        }

        // ============================================
        // DATA POPUP
        // ============================================
        function initPopupDragHandlers() {
            const popup = document.getElementById('dataPopup');
            let popupDragStartX = 0;
            let popupDragOffset = 0;
            let popupIsDragging = false;

            const startPopupDrag = (e) => {
                if (e.target.id === 'dataPopup') {
                    popupIsDragging = true;
                    popupDragStartX = e.touches ? e.touches[0].clientX : e.clientX;
                    popupDragOffset = 0;
                }
            };

            const popupDrag = (e) => {
                if (!popupIsDragging) return;
                const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                popupDragOffset = currentX - popupDragStartX;
            };

            const endPopupDrag = () => {
                if (!popupIsDragging) return;

                if (Math.abs(popupDragOffset) > 100) {
                    closeDataPopup();
                }

                popupIsDragging = false;
                popupDragOffset = 0;
            };

            popup.addEventListener('touchstart', startPopupDrag, { passive: false });
            popup.addEventListener('touchmove', popupDrag, { passive: false });
            popup.addEventListener('touchend', endPopupDrag);
            popup.addEventListener('mousedown', startPopupDrag);
            document.addEventListener('mousemove', popupDrag);
            document.addEventListener('mouseup', endPopupDrag);
        }

        function showDataPopup(timestamp) {
            const entry = quizData.find(e => e.timestamp === timestamp);
            if (!entry) return;

            const ts = new Date(entry.timestamp);
            const displayTime = ts.toLocaleString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            let content = `<div class="popup-date">${displayTime}</div>`;

            // Daily rating FIRST
            const ratingQuestion = questions.find(q => q.id === 'rating');
            if (ratingQuestion && entry[ratingQuestion.id]) {
                const rating = entry[ratingQuestion.id];
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title"><span>Daily Rating</span></div>`;
                content += `<div class="popup-rating">${rating > 0 ? '+' : ''}${rating}</div>`;
                content += `</div>`;
            }

            // Daily response SECOND
            const responseQuestion = questions.find(q => q.id === 'text');
            if (responseQuestion && entry[responseQuestion.id]) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title"><span>Daily Response</span></div>`;
                content += `<div class="popup-response">${entry[responseQuestion.id]}</div>`;
                content += `</div>`;
            }

            // Hours tracking
            const hoursQuestions = questions.filter(q => q.section === 'hours');
            if (hoursQuestions.length > 0 && hoursQuestions.some(q => entry[q.id])) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title"><span>Hours Tracking</span></div>`;
                hoursQuestions.forEach(q => {
                    const hours = entry[q.id];
                    if (hours !== undefined && hours !== '') {
                        content += `<div class="popup-hours" style="color: ${q.colorHex}">${q.text}: ${hours}h</div>`;
                    }
                });
                content += `</div>`;
            }

            // Morning section
            const morningQuestions = questions.filter(q => q.section === 'morning');
            if (morningQuestions.length > 0) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title">${SUN_ICON}<span>Morning Checklist</span></div>`;
                morningQuestions.forEach(q => {
                    const answer = entry[q.id];
                    const className = answer === 'yes' ? 'yes' : 'no';
                    content += `<div class="popup-item ${className}" style="color: ${q.colorHex}">${q.text} ${answer === 'yes' ? '✓' : '✗'}</div>`;
                });
                content += `</div>`;
            }

            // Evening section
            const eveningQuestions = questions.filter(q => q.section === 'evening');
            if (eveningQuestions.length > 0) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title">${MOON_ICON}<span>Evening Checklist</span></div>`;
                eveningQuestions.forEach(q => {
                    const answer = entry[q.id];
                    const className = answer === 'yes' ? 'yes' : 'no';
                    content += `<div class="popup-item ${className}" style="color: ${q.colorHex}">${q.text} ${answer === 'yes' ? '✓' : '✗'}</div>`;
                });
                content += `</div>`;
            }

            // Daily section
            const dailyQuestions = questions.filter(q => q.section === 'daily');
            if (dailyQuestions.length > 0) {
                content += `<div class="popup-section">`;
                content += `<div class="popup-section-title"><span>Daily Checklist</span></div>`;
                dailyQuestions.forEach(q => {
                    const answer = entry[q.id];
                    const className = answer === 'yes' ? 'yes' : 'no';
                    content += `<div class="popup-item ${className}" style="color: ${q.colorHex}">${q.text} ${answer === 'yes' ? '✓' : '✗'}</div>`;
                });
                content += `</div>`;
            }

            document.getElementById('popupContent').innerHTML = content;
            document.getElementById('dataPopup').classList.add('active');
        }

        function closeDataPopup() {
            document.getElementById('dataPopup').classList.remove('active');
        }

        // ============================================
        // CHART - UPDATED TO USE IDs
        // ============================================
        function updateChart() {
            const canvas = document.getElementById('myChart');
            const ctx = canvas.getContext('2d');

            // Filter data
            let filteredData = [...quizData].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (!showAllData && filteredData.length > 0) {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                filteredData = filteredData.filter(entry => new Date(entry.timestamp) >= thirtyDaysAgo);
            }

            let chartData;
            
            if (chartMode === 'percent') {
                // Build percentage chart data using IDs
                chartData = filteredData.map(entry => {
                    const timestamp = new Date(entry.timestamp);

                    const cyanQuestions = questions.filter(q => q.color === 'C' && q.type === 'yesno');
                    const magentaQuestions = questions.filter(q => q.color === 'M' && q.type === 'yesno');
                    const yellowQuestions = questions.filter(q => q.color === 'Y' && q.type === 'yesno');

                    const cyanYes = cyanQuestions.filter(q => entry[q.id] === 'yes').length;
                    const magentaYes = magentaQuestions.filter(q => entry[q.id] === 'yes').length;
                    const yellowYes = yellowQuestions.filter(q => entry[q.id] === 'yes').length;

                    const cyanPercent = cyanQuestions.length > 0 ? (cyanYes / cyanQuestions.length) * 100 : 0;
                    const magentaPercent = magentaQuestions.length > 0 ? (magentaYes / magentaQuestions.length) * 100 : 0;
                    const yellowPercent = yellowQuestions.length > 0 ? (yellowYes / yellowQuestions.length) * 100 : 0;

                    // Use stable ID for rating
                    const rating = parseFloat(entry['rating']);
                    let ratingPercent = isNaN(rating) || entry['rating'] === '' ? null : ((rating + 2) / 4) * 100;

                    // Check substance use using IDs: d1=nicotine, d2=cannabis, d3=alcohol
                    const hasSubstanceUse = 
                        entry['d1'] === 'no' || 
                        entry['d2'] === 'no' || 
                        entry['d3'] === 'no';

                    // Check nootropics using ID: d5=nootropics
                    const hasNootropics = entry['d5'] === 'yes';

                    return {
                        x: timestamp,
                        originalTimestamp: entry.timestamp,
                        cyan: cyanPercent,
                        magenta: magentaPercent,
                        yellow: yellowPercent,
                        rating: ratingPercent,
                        hasSubstanceUse: hasSubstanceUse,
                        hasNootropics: hasNootropics
                    };
                });
            } else {
                // Build hours chart data using IDs: h1-h4
                chartData = filteredData.map(entry => {
                    const timestamp = new Date(entry.timestamp);

                    const pinkHours = parseFloat(entry['h1']) || 0;        // h1 = pinkProportion
                    const studioHours = parseFloat(entry['h2']) || 0;      // h2 = forma rosa studio
                    const creativeHours = parseFloat(entry['h3']) || 0;    // h3 = forma rosa creative
                    const healthHours = parseFloat(entry['h4']) || 0;      // h4 = health

                    // Convert rating to 0-24 scale for overlay
                    const rating = parseFloat(entry['rating']);
                    let ratingScaled = isNaN(rating) || entry['rating'] === '' ? null : ((rating + 2) / 4) * 24;

                    return {
                        x: timestamp,
                        originalTimestamp: entry.timestamp,
                        magenta: pinkHours,
                        cyan: studioHours,
                        yellow: creativeHours,
                        white: healthHours,
                        rating: ratingScaled
                    };
                });
            }

            if (chart) {
                chart.destroy();
            }

            // Substance line plugin (works for both modes now)
            const substanceLinePlugin = {
                id: 'substanceLines',
                beforeDatasetsDraw(chart) {
                    if (chartMode !== 'percent') return;
                    
                    const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
                    const dataset = chart.data.datasets[0];

                    dataset.data.forEach((point, index) => {
                        const dataPoint = chartData[index];
                        if (dataPoint) {
                            const xPos = x.getPixelForValue(point.x);
                            
                            // Draw red line for harmful substances
                            if (dataPoint.hasSubstanceUse) {
                                ctx.save();
                                ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(xPos, top);
                                ctx.lineTo(xPos, bottom);
                                ctx.stroke();
                                ctx.restore();
                            }

                            // Draw green line for nootropics
                            if (dataPoint.hasNootropics) {
                                ctx.save();
                                ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(xPos, top);
                                ctx.lineTo(xPos, bottom);
                                ctx.stroke();
                                ctx.restore();
                            }
                        }
                    });
                }
            };

            // Configure chart based on mode
            if (chartMode === 'percent') {
                // Percentage mode: line chart
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Cyan',
                                data: chartData.map(d => ({ x: d.x, y: d.cyan })),
                                borderColor: '#00FFFF',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.1
                            },
                            {
                                label: 'Magenta',
                                data: chartData.map(d => ({ x: d.x, y: d.magenta })),
                                borderColor: '#FF00FF',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.1
                            },
                            {
                                label: 'Yellow',
                                data: chartData.map(d => ({ x: d.x, y: d.yellow })),
                                borderColor: '#FFFF00',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.1
                            },
                            {
                                label: 'Rating',
                                data: chartData.map(d => ({ x: d.x, y: d.rating })),
                                borderColor: '#FFFFFF',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const timestamp = chartData[index].originalTimestamp;
                                showDataPopup(timestamp);
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    displayFormats: {
                                        day: 'M-d-yy'
                                    }
                                },
                                grid: {
                                    color: '#1A1A1A'
                                },
                                ticks: {
                                    color: '#666'
                                }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                grid: {
                                    color: '#1A1A1A'
                                },
                                ticks: {
                                    color: '#666',
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(13, 13, 13, 0.9)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                borderColor: '#333',
                                borderWidth: 1
                            }
                        }
                    },
                    plugins: [substanceLinePlugin]
                });
            } else {
                // Hours mode: stacked bar chart
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        datasets: [
                            {
                                label: 'Pink',
                                data: chartData.map(d => ({ x: d.x, y: d.magenta })),
                                backgroundColor: '#FF00FF',
                                borderColor: 'transparent',
                                borderWidth: 0,
                                order: 4
                            },
                            {
                                label: 'Studio',
                                data: chartData.map(d => ({ x: d.x, y: d.cyan })),
                                backgroundColor: '#00FFFF',
                                borderColor: 'transparent',
                                borderWidth: 0,
                                order: 3
                            },
                            {
                                label: 'Creative',
                                data: chartData.map(d => ({ x: d.x, y: d.yellow })),
                                backgroundColor: '#FFFF00',
                                borderColor: 'transparent',
                                borderWidth: 0,
                                order: 2
                            },
                            {
                                label: 'Health',
                                data: chartData.map(d => ({ x: d.x, y: d.white })),
                                backgroundColor: '#FFFFFF',
                                borderColor: 'transparent',
                                borderWidth: 0,
                                order: 1
                            },
                            {
                                label: 'Rating',
                                data: chartData.map(d => ({ x: d.x, y: d.rating })),
                                type: 'line',
                                borderColor: '#FFFFFF',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.1,
                                order: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const timestamp = chartData[index].originalTimestamp;
                                showDataPopup(timestamp);
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    displayFormats: {
                                        day: 'M-d-yy'
                                    }
                                },
                                stacked: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#666'
                                }
                            },
                            y: {
                                stacked: true,
                                min: 0,
                                max: 24,
                                grid: {
                                    color: (context) => {
                                        if (context.tick.value === 0 || context.tick.value === 24) {
                                            return '#666';
                                        }
                                        return 'transparent';
                                    }
                                },
                                ticks: {
                                    color: '#666',
                                    stepSize: 6,
                                    callback: function(value) {
                                        return value + 'h';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(13, 13, 13, 0.9)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                borderColor: '#333',
                                borderWidth: 1
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // QUIZ LOGIC
        // ============================================
        function startQuiz() {
            currentQuestionIndex = 0;
            responses = {};
            showScreen('quizScreen');
            renderQuestion();
        }

        function renderQuestion() {
            const question = questions[currentQuestionIndex];
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            const container = document.getElementById('cardContainer');
            
            if (question.type === 'yesno') {
                container.innerHTML = `
                    <div 
                        id="card" 
                        class="card" 
                        style="border-color: ${question.colorHex};"
                        onmousedown="startDrag(event)"
                        ontouchstart="startDrag(event)"
                    >
                        <div class="section-label" style="color: ${question.colorHex};">
                            ${question.section === 'morning' ? SUN_ICON : ''}
                            ${question.section === 'evening' ? MOON_ICON : ''}
                            <span>${question.section}</span>
                        </div>
                        <div class="question-text" style="color: ${question.colorHex};">
                            ${question.text}
                        </div>
                        <div class="swipe-hint" style="color: ${question.colorHex};">
                            <span>← no</span>
                            <span>yes →</span>
                        </div>
                    </div>
                `;

                const card = document.getElementById('card');
                card.addEventListener('mousemove', drag);
                card.addEventListener('touchmove', drag, { passive: false });
                card.addEventListener('mouseup', endDrag);
                card.addEventListener('touchend', endDrag);
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag, { passive: false });
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
            } else if (question.type === 'text') {
                container.innerHTML = `
                    <div class="text-container">
                        <div class="question-text" style="color: ${question.colorHex}; font-size: 24px; margin-bottom: 20px;">${question.text}</div>
                        <textarea 
                            id="textInput" 
                            class="text-input" 
                            placeholder="type your thoughts here..."
                            style="border-color: ${question.colorHex};"
                        ></textarea>
                        <button 
                            id="micBtn"
                            class="mic-button" 
                            style="border-color: ${question.colorHex}; color: ${question.colorHex};"
                            onclick="toggleRecording()"
                        >
                            ${MIC_ICON}
                            <span>record</span>
                        </button>
                        <button 
                            class="text-submit" 
                            style="border-color: ${question.colorHex}; color: ${question.colorHex};"
                            onclick="submitText()"
                        >
                            submit
                        </button>
                    </div>
                `;
            } else if (question.type === 'rating') {
                container.innerHTML = `
                    <div class="rating-container">
                        <div class="question-text" style="color: ${question.colorHex}; font-size: 24px; margin-bottom: 20px;">${question.text}</div>
                        <div class="rating-circles">
                            ${[-2, -1, 0, 1, 2].map(value => `
                                <div 
                                    class="rating-circle" 
                                    style="border-color: ${question.colorHex}; color: ${question.colorHex};"
                                    data-value="${value}"
                                    onclick="selectRating(${value})"
                                >
                                    ${value > 0 ? '+' : ''}${value}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (question.type === 'hours') {
                container.innerHTML = `
                    <div class="slider-container">
                        <div class="question-text" style="color: ${question.colorHex}; font-size: 24px; margin-bottom: 20px;">${question.text}</div>
                        <div class="slider-value" id="sliderValue" style="color: ${question.colorHex}">0</div>
                        <div class="slider-wrapper">
                            <input 
                                type="range" 
                                min="0" 
                                max="12" 
                                value="0" 
                                class="hour-slider" 
                                id="hourSlider"
                                style="background: linear-gradient(to right, ${question.colorHex} 0%, #1A1A1A 0%);"
                                oninput="updateSliderValue(this.value, '${question.colorHex}')"
                            />
                            <div class="slider-labels">
                                <span>0</span>
                                <span>12</span>
                            </div>
                        </div>
                        <button 
                            class="slider-submit" 
                            style="border-color: ${question.colorHex}; color: ${question.colorHex};"
                            onclick="submitHours()"
                        >
                            submit
                        </button>
                    </div>
                `;
                
                // Set thumb color
                const style = document.createElement('style');
                style.textContent = `
                    #hourSlider::-webkit-slider-thumb { background: ${question.colorHex}; }
                    #hourSlider::-moz-range-thumb { background: ${question.colorHex}; }
                `;
                document.head.appendChild(style);
            }
        }

        function updateSliderValue(value, color) {
            document.getElementById('sliderValue').textContent = value;
            const slider = document.getElementById('hourSlider');
            const percentage = (value / 12) * 100;
            slider.style.background = `linear-gradient(to right, ${color} ${percentage}%, #1A1A1A ${percentage}%)`;
        }

        function submitHours() {
            const slider = document.getElementById('hourSlider');
            const value = parseInt(slider.value);
            const question = questions[currentQuestionIndex];
            
            // CRITICAL: Save using ID, not text
            responses[question.id] = value;
            
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                completeQuiz();
            }
        }

        function toggleRecording() {
            if (!recognition) {
                alert('Speech recognition not supported on this device');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) return;

            try {
                recognition.start();
                isRecording = true;
                const micBtn = document.getElementById('micBtn');
                if (micBtn) {
                    micBtn.classList.add('recording');
                    micBtn.innerHTML = `${MIC_ICON}<span>recording...</span>`;
                }
            } catch (error) {
                console.error('Failed to start recording:', error);
            }
        }

        function stopRecording() {
            if (!recognition || !isRecording) return;

            try {
                recognition.stop();
            } catch (error) {
                console.error('Failed to stop recording:', error);
            }

            isRecording = false;
            const micBtn = document.getElementById('micBtn');
            if (micBtn) {
                micBtn.classList.remove('recording');
                micBtn.innerHTML = `${MIC_ICON}<span>record</span>`;
            }
        }

        function submitText() {
            const textInput = document.getElementById('textInput');
            if (!textInput) return;

            const text = textInput.value.trim();

            if (!text) {
                alert('Please enter a response');
                return;
            }

            stopRecording();

            const question = questions[currentQuestionIndex];
            // CRITICAL: Save using ID, not text
            responses[question.id] = text;

            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                completeQuiz();
            }
        }

        function selectRating(value) {
            const question = questions[currentQuestionIndex];

            // CRITICAL: Save using ID and as number
            responses[question.id] = Number(value);

            const circles = document.querySelectorAll('.rating-circle');
            circles.forEach(circle => {
                const circleValue = parseInt(circle.dataset.value);
                if (circleValue <= value) {
                    circle.style.backgroundColor = '#FF00FF';
                    circle.style.color = '#0D0D0D';
                } else {
                    circle.style.backgroundColor = 'transparent';
                    circle.style.color = question.colorHex;
                }
            });

            setTimeout(() => {
                completeQuiz();
            }, 300);
        }

        function handleAnswer(answer) {
            const question = questions[currentQuestionIndex];

            if (question.type === 'yesno') {
                // CRITICAL: Save using ID, not text
                responses[question.id] = answer;
            }

            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                completeQuiz();
            }
        }

        async function completeQuiz() {
            const timestamp = new Date().toISOString();
            const data = {
                timestamp,
                ...responses  // responses now use IDs as keys
            };

            await saveToSheet(data);
            showScreen('chartScreen');
        }

        // ============================================
        // DRAG HANDLERS
        // ============================================
        function startDrag(e) {
            const question = questions[currentQuestionIndex];
            if (question.type === 'rating' || question.type === 'text' || question.type === 'hours') return;

            e.preventDefault();
            isDragging = true;
            dragStartX = e.touches ? e.touches[0].clientX : e.clientX;
            dragOffset = 0;

            const card = document.getElementById('card');
            if (card) card.classList.add('dragging');
        }

        function drag(e) {
            if (!isDragging) return;

            const question = questions[currentQuestionIndex];
            const currentX = e.touches ? e.touches[0].clientX : e.clientX;
            dragOffset = currentX - window.innerWidth / 2;

            const rotation = dragOffset * 0.1;
            const shouldShowColor = dragOffset > 100;

            const card = document.getElementById('card');
            if (!card) return;

            card.style.transform = `translateX(${dragOffset}px) rotate(${rotation}deg)`;

            if (shouldShowColor) {
                card.style.backgroundColor = question.colorHex;
                const textElements = card.querySelectorAll('.section-label, .question-text');
                textElements.forEach(el => el.style.color = '#0D0D0D');
            } else {
                card.style.backgroundColor = '#0D0D0D';
                const textElements = card.querySelectorAll('.section-label, .question-text');
                textElements.forEach(el => el.style.color = question.colorHex);
            }
        }

        function endDrag() {
            if (!isDragging) return;

            const card = document.getElementById('card');
            if (!card) return;

            if (Math.abs(dragOffset) > 100) {
                if (dragOffset > 0) {
                    handleAnswer('yes');
                } else {
                    handleAnswer('no');
                }
            } else {
                card.style.transform = 'none';
                card.style.backgroundColor = '#0D0D0D';
                const question = questions[currentQuestionIndex];
                const textElements = card.querySelectorAll('.section-label, .question-text');
                textElements.forEach(el => el.style.color = question.colorHex);
            }

            isDragging = false;
            dragOffset = 0;
            card.classList.remove('dragging');
        }
    </script>
</body>
</html>
